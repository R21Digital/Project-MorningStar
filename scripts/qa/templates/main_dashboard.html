<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MS11 - MorningStar Dashboard</title>
    <link rel="icon" href="/img/ms11-logo-32.png" sizes="32x32">
    <link rel="icon" href="/img/ms11-logo-192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="/img/ms11-logo-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body class="bg-neutral-950 text-neutral-200 min-h-screen">
    <header class="border-b border-neutral-800 bg-neutral-950/80 sticky top-0 z-40 backdrop-blur">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                    <img src="/img/ms11-logo-64.png" alt="MS11"
                        class="h-8 w-8 rounded-md ring-1 ring-primary-700 bg-primary-600/10"
                        onerror="this.style.display='none'">
                    <span class="font-semibold tracking-tight text-neutral-100">MS11 - MorningStar</span>
                </a>
            </div>
            <nav class="hidden md:flex items-center gap-4">
                <a href="/" class="text-neutral-400 hover:text-neutral-200 transition-colors text-sm">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="/ms11-dashboard.html" class="text-neutral-400 hover:text-neutral-200 transition-colors text-sm">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="configuration.html" class="text-neutral-400 hover:text-neutral-200 transition-colors text-sm">
                    <i class="fas fa-cog"></i> Config
                </a>
                <a href="analytics.html" class="text-neutral-400 hover:text-neutral-200 transition-colors text-sm">
                    <i class="fas fa-chart-bar"></i> Analytics
                </a>
            </nav>
            <div class="flex items-center gap-2">
                <button onclick="showSystemInfo()"
                    class="inline-flex items-center gap-2 px-3 py-2 rounded-md ring-1 ring-neutral-700 bg-neutral-900 hover:bg-neutral-800 text-neutral-200">
                    <i class="fas fa-info-circle"></i>
                    <span class="hidden sm:inline">System Info</span>
                </button>
                <button onclick="refreshStatus()"
                    class="inline-flex items-center gap-2 px-3 py-2 rounded-md ring-1 ring-neutral-700 bg-neutral-900 hover:bg-neutral-800 text-neutral-200">
                    <i class="fas fa-rotate"></i>
                    <span class="hidden sm:inline">Refresh</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 space-y-8">
        <!-- Status Banner -->
        <section class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-xl font-semibold text-neutral-100 flex items-center gap-2">
                        <i class="fas fa-rocket text-primary-400"></i>
                        MS11 System Dashboard
                    </h1>
                    <p class="text-sm text-neutral-400">Comprehensive management interface for the MorningStar Project
                    </p>
                </div>
                <div class="text-right">
                    <div id="systemHealth"
                        class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm ring-1 ring-neutral-700 bg-neutral-800 text-neutral-200">
                        <i class="fas fa-check-circle text-green-400"></i>
                        <span>System Healthy</span>
                    </div>
                    <div class="mt-2 text-xs text-neutral-400">
                        Version: <span id="systemVersion" class="text-neutral-300">{{ state.version }}</span>
                        <span class="mx-2">•</span>
                        Last Update: <span id="lastUpdate" class="text-neutral-300">{{ state.last_update }}</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-medium tracking-wide text-neutral-400 uppercase">Quick Actions</h2>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="btnStartAll"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-primary-600 hover:bg-primary-500 text-white ring-1 ring-primary-700"
                    onclick="quickAction('start_all')">
                    <i class="fas fa-play"></i> Start All Services
                </button>
                <button id="btnStopAll"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-neutral-800 hover:bg-neutral-700 text-neutral-100 ring-1 ring-neutral-700"
                    onclick="quickAction('stop_all')">
                    <i class="fas fa-stop"></i> Stop All Services
                </button>
                <button
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-neutral-800 hover:bg-neutral-700 text-neutral-100 ring-1 ring-neutral-700"
                    onclick="quickAction('restart_all')">
                    <i class="fas fa-rotate"></i> Restart All Services
                </button>
                <button
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-neutral-800 hover:bg-neutral-700 text-neutral-100 ring-1 ring-neutral-700"
                    onclick="quickAction('backup')">
                    <i class="fas fa-download"></i> Backup System
                </button>
                <button
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-neutral-800 hover:bg-neutral-700 text-neutral-100 ring-1 ring-neutral-700"
                    onclick="quickAction('diagnostics')">
                    <i class="fas fa-stethoscope"></i> Run Diagnostics
                </button>
            </div>
        </section>

        <!-- Lightweight Stats Row (populated by ms11-dashboard.js) -->
        <section>
            <div id="statsRow" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-2"></div>
        </section>

        <!-- System Statistics -->
        <section>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                    <div class="text-sm text-neutral-400">Active Modules</div>
                    <div id="activeModules" class="mt-2 text-3xl font-semibold text-neutral-100">{{
                        state.active_modules|length }}</div>
                </div>
                <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                    <div class="text-sm text-neutral-400">Total Modules</div>
                    <div id="totalModules" class="mt-2 text-3xl font-semibold text-neutral-100">{{ modules|length }}
                    </div>
                </div>
                <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                    <div class="text-sm text-neutral-400">Active Sessions</div>
                    <div id="activeSessions" class="mt-2 text-3xl font-semibold text-neutral-100">{{
                        state.active_sessions }}</div>
                </div>
                <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                    <div class="text-sm text-neutral-400">Total Operations</div>
                    <div id="totalOperations" class="mt-2 text-3xl font-semibold text-neutral-100">{{
                        state.total_operations }}</div>
                </div>
            </div>
        </section>

        <!-- MS11 Modules -->
        <section class="space-y-4">
            <h2 class="text-sm font-medium tracking-wide text-neutral-400 uppercase">System Modules</h2>
            <div id="modulesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for module_id, module in modules.items() %}
                <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5 hover:ring-primary-600 hover:shadow-lg hover:shadow-primary-600/10 transition cursor-pointer"
                    onclick="navigateToModule('{{ module.route }}')">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="h-10 w-10 rounded-md bg-primary-600/20 ring-1 ring-primary-700 flex items-center justify-center">
                                <i class="{{ module.icon }} text-primary-400"></i>
                            </div>
                            <div>
                                <div class="text-neutral-100 font-medium">{{ module.name }}</div>
                                <div class="text-neutral-400 text-sm">{{ module.description }}</div>
                            </div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-md ring-1 ring-neutral-700"
                            data-status="{{ module.status }}">{{ module.status|title }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Session Launcher -->
        <section class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-medium tracking-wide text-neutral-400 uppercase">Launch Session</h2>
                <div id="attachmentPill" class="text-xs px-2 py-1 rounded bg-neutral-800 ring-1 ring-neutral-700">
                    Attachment: —</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input id="inpCharacter"
                    class="px-3 py-2 rounded-md bg-neutral-900 ring-1 ring-neutral-800 text-neutral-100"
                    placeholder="Character name" />
                <input id="inpProfile"
                    class="px-3 py-2 rounded-md bg-neutral-900 ring-1 ring-neutral-800 text-neutral-100"
                    placeholder="Profile id (e.g. legacy_tatooine_01)" />
                <select id="selMode"
                    class="px-3 py-2 rounded-md bg-neutral-900 ring-1 ring-neutral-800 text-neutral-100">
                    <option value="quest">Quest</option>
                    <option value="farm">Farm</option>
                    <option value="trainer">Trainer</option>
                    <option value="paper">Paper</option>
                </select>
                <button id="btnLaunch"
                    class="inline-flex items-center justify-center px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-500 text-white ring-1 ring-emerald-700">Start
                    Session</button>
            </div>
        </section>

        <!-- Sessions Table -->
        <section class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-medium tracking-wide text-neutral-400 uppercase">Sessions</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-neutral-400">
                        <tr>
                            <th class="text-left p-2">ID</th>
                            <th class="text-left p-2">Character</th>
                            <th class="text-left p-2">Profile</th>
                            <th class="text-left p-2">Mode</th>
                            <th class="text-left p-2">Status</th>
                            <th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTbody"></tbody>
                </table>
            </div>
        </section>

        <!-- Live Logs -->
        <section class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-6">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-sm font-medium tracking-wide text-neutral-400 uppercase">Live Logs</h2>
                <button id="btnClearLog"
                    class="text-xs px-2 py-1 rounded bg-neutral-900 ring-1 ring-neutral-800">Clear</button>
            </div>
            <pre id="logPane" class="h-56 overflow-auto bg-black/60 p-3 rounded text-xs"></pre>
        </section>

        <!-- Performance Chart -->
        <section class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-medium tracking-wide text-neutral-400 uppercase">System Performance</h2>
                <div class="flex items-center gap-2">
                    <button onclick="detectMounts()"
                        class="inline-flex items-center gap-2 px-3 py-2 rounded-md ring-1 ring-neutral-700 bg-neutral-900 hover:bg-neutral-800 text-neutral-200">
                        <i class="fas fa-horse"></i>
                        Detect Mounts
                    </button>
                    <button onclick="autoMount()"
                        class="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-primary-600 hover:bg-primary-500 text-white ring-1 ring-primary-700">
                        <i class="fas fa-forward"></i>
                        Auto Mount (150m)
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2 h-64">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="rounded-lg ring-1 ring-neutral-800 bg-neutral-900/60 p-4 text-sm">
                    <div class="font-medium text-neutral-300 mb-2">Server Info</div>
                    <div id="serverInfo" class="space-y-1 text-neutral-400">
                        <div>CPU: <span id="serverCpu">—</span>%</div>
                        <div>Memory: <span id="serverMem">—</span> MB</div>
                        <div>Uptime: <span id="serverUptime">—</span></div>
                        <div>Modules: <span id="serverModules">—</span></div>
                    </div>
                </div>
            </div>
            <div id="mountsList" class="mt-4 text-xs text-neutral-400"></div>
        </section>
    </main>

    <footer class="border-t border-neutral-800 mt-12">
        <div class="max-w-7xl mx-auto px-6 py-6 text-xs text-neutral-500">
            MS11 MorningStar Project — Built with Flask & Socket.IO
        </div>
    </footer>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed bottom-6 right-6 space-y-2 z-50"></div>

    <!-- Optional: Hook minimal client wiring if not using the standalone public page -->
    <script type="module">
        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));
        const fmt = v => typeof v === 'number' ? v.toLocaleString() : v;

        async function loadModules() {
            try {
                let res = await fetch('/api/modules/overview');
                if (!res.ok) res = await fetch('/api/system/overview');
                const { modules } = await res.json();
                const grid = document.getElementById('modulesGrid');
                if (!grid) return;
                grid.innerHTML = modules.map(m => `
                    <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                      <div class="flex items-center justify-between">
                        <div class="font-medium text-neutral-100">${m.name}</div>
                        <span class="text-xs px-2 py-1 rounded ${m.health === 'active' ? 'bg-emerald-700 text-emerald-100' : m.health === 'degraded' ? 'bg-amber-700 text-amber-100' : m.health === 'error' ? 'bg-rose-700 text-rose-100' : 'bg-neutral-800 text-neutral-300'}">${m.health}</span>
                      </div>
                      <div class="text-neutral-400 text-sm mt-1">${m.description}</div>
                      <dl class="grid grid-cols-3 gap-2 mt-3">
                        ${m.metrics.slice(0, 3).map(mm => `
                          <div class="rounded ring-1 ring-neutral-800 bg-neutral-900/60 p-2">
                            <dt class="text-neutral-400 text-xs">${mm.label}</dt>
                            <dd class="text-neutral-100">${fmt(mm.value)}</dd>
                          </div>`).join('')}
                      </dl>
                    </div>`).join('');
                const active = modules.filter(m => m.health === 'active').length;
                const statsRow = document.getElementById('statsRow');
                if (statsRow) statsRow.innerHTML = [
                    { label: 'Active Modules', value: active },
                    { label: 'Total Modules', value: modules.length },
                ].map(s => `
                    <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                      <div class="text-sm text-neutral-400">${s.label}</div>
                      <div class="mt-2 text-3xl font-semibold text-neutral-100">${fmt(s.value)}</div>
                    </div>`).join('');
            } catch { }
        }

        async function loadSystem() {
            try {
                const r = await fetch('/api/system/info');
                if (!r.ok) return;
                const s = await r.json();
                const row = document.getElementById('statsRow');
                if (!row) return;
                row.insertAdjacentHTML('beforeend', `
                  <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                    <div class="text-sm text-neutral-400">CPU</div>
                    <div class="mt-2 text-3xl font-semibold text-neutral-100">${fmt(s.cpu)}</div>
                  </div>`);
                row.insertAdjacentHTML('beforeend', `
                  <div class="rounded-xl ring-1 ring-neutral-800 bg-neutral-900/60 p-5">
                    <div class="text-sm text-neutral-400">Memory Used</div>
                    <div class="mt-2 text-3xl font-semibold text-neutral-100">${fmt(s.memUsedPct)}%</div>
                  </div>`);
            } catch { }
        }

        async function loadSessions() {
            try {
                const r = await fetch('/api/sessions');
                const { sessions } = await r.json();
                const tb = document.getElementById('sessionsTbody');
                if (!tb) return;
                tb.innerHTML = sessions.map(s => `
                  <tr class="border-t border-neutral-800">
                    <td class="p-2">${s.id.slice(0, 8)}</td>
                    <td class="p-2">${s.character}</td>
                    <td class="p-2">${s.profile}</td>
                    <td class="p-2">${s.mode}</td>
                    <td class="p-2">${s.status}</td>
                    <td class="p-2 text-right">${s.status === 'running' ? `<button data-stop="${s.id}" class="px-2 py-1 rounded bg-neutral-900 ring-1 ring-neutral-800 text-xs">Stop</button>` : ''}</td>
                  </tr>`).join('');
                $$('#sessionsTbody [data-stop]').forEach(b => b.addEventListener('click', async ev => {
                    const id = ev.currentTarget.getAttribute('data-stop');
                    await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
                }));
            } catch { }
        }

        const socket = io();
        const logs = [];
        const logPane = document.getElementById('logPane');
        function pushLog(line) {
            if (!logPane) return;
            logs.push(line); while (logs.length > 200) logs.shift();
            logPane.textContent = logs.join('\n');
            logPane.scrollTop = logPane.scrollHeight;
        }

        try { document.getElementById('btnClearLog')?.addEventListener('click', () => { logs.length = 0; if (logPane) logPane.textContent = ''; }); } catch { }
        try { document.getElementById('btnStartAll')?.addEventListener('click', () => fetch('/api/services/startAll', { method: 'POST' })); } catch { }
        try { document.getElementById('btnStopAll')?.addEventListener('click', () => fetch('/api/services/stopAll', { method: 'POST' })); } catch { }
        try {
            document.getElementById('btnLaunch')?.addEventListener('click', async () => {
                const body = {
                    character: document.getElementById('inpCharacter')?.value || 'Player',
                    profile: document.getElementById('inpProfile')?.value || 'legacy_tatooine_01',
                    mode: document.getElementById('selMode')?.value || 'quest',
                };
                await fetch('/api/sessions', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(body) });
            });
        } catch { }

        socket.on('log', e => pushLog(`[${(e.level || 'info').toUpperCase()}] [${e.source}] ${e.msg}`));
        socket.on('metric', e => {
            if (e.key === 'attachment') {
                const pill = document.getElementById('attachmentPill');
                if (!pill) return;
                const on = Number(e.value) === 1;
                pill.textContent = `Attachment: ${on ? 'Attached' : 'Detached'}`;
                pill.className = `text-xs px-2 py-1 rounded ${on ? 'bg-emerald-700' : 'bg-neutral-800'}`;
            }
        });
        socket.on('session', _ => loadSessions());

        (async function boot() {
            await loadModules();
            await loadSystem();
            await loadSessions();
        })();
    </script>

    <script>
        // Socket.IO connection
        const socket = io();

        // Global variables
        let performanceData = [];
        let performanceChart;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            initializePerformanceChart();
            setupSocketListeners();
            updateSystemInfo();
        });

        // Socket.IO event listeners
        function setupSocketListeners() {
            socket.on('connect', function () {
                console.log('Connected to MS11 server');
                showNotification('Connected to MS11 server', 'success');
            });

            socket.on('disconnect', function () {
                console.log('Disconnected from MS11 server');
                showNotification('Disconnected from MS11 server', 'warning');
            });

            socket.on('status_update', function (data) {
                updateSystemInfo(data);
            });

            socket.on('action_response', function (data) {
                showNotification(data.message, data.success ? 'success' : 'error');
            });

            socket.on('diagnostics_result', function (data) {
                showNotification('Diagnostics finished', 'success');
                const container = document.getElementById('serverInfo');
                if (container && data) {
                    const p = document.createElement('div');
                    p.className = 'text-xs text-neutral-500';
                    p.textContent = `Diag @ ${new Date(data.timestamp).toLocaleTimeString()} • CPU ${data.metrics?.cpu_usage ?? '—'}% • Mem ${data.metrics?.memory_mb ?? '—'} MB`;
                    container.appendChild(p);
                }
            });
        }

        // Initialize performance chart
        function initializePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'System Performance',
                        data: [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.12)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(229, 229, 229, 0.9)'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(212, 212, 212, 0.8)'
                            },
                            grid: {
                                color: 'rgba(64, 64, 64, 0.6)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(212, 212, 212, 0.8)'
                            },
                            grid: {
                                color: 'rgba(64, 64, 64, 0.6)'
                            }
                        }
                    }
                }
            });
        }

        // Update system information
        function updateSystemInfo(data = null) {
            if (data) {
                // Update from socket data
                document.getElementById('systemVersion').textContent = data.version;
                document.getElementById('lastUpdate').textContent = new Date(data.last_update).toLocaleString();
                document.getElementById('activeModules').textContent = data.active_modules.length;
                document.getElementById('totalOperations').textContent = data.total_operations;

                // Update system health
                updateSystemHealth(data.system_health);

                // Update performance chart
                updatePerformanceChart(data.performance_metrics);

                // Update server info
                if (data.performance_metrics) {
                    document.getElementById('serverCpu').textContent = data.performance_metrics.cpu_usage ?? '—';
                    document.getElementById('serverMem').textContent = data.performance_metrics.memory_mb ?? '—';
                }
                document.getElementById('serverModules').textContent = (data.active_modules || []).length;
            } else {
                // Update from page data
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => updateSystemInfo(data))
                    .catch(error => console.error('Error fetching status:', error));
            }
        }

        // Update system health indicator
        function updateSystemHealth(health) {
            const el = document.getElementById('systemHealth');
            let icon = '<i class="fas fa-check-circle text-green-400"></i>';
            let base = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm ring-1 ';
            let cls = 'ring-neutral-700 bg-neutral-800 text-neutral-200';
            let label = 'System Healthy';
            if (health === 'warning') {
                icon = '<i class="fas fa-exclamation-triangle text-yellow-400"></i>';
                label = 'System Warning';
            }
            if (health === 'error') {
                icon = '<i class="fas fa-times-circle text-red-400"></i>';
                label = 'System Error';
            }
            el.className = base + cls;
            el.innerHTML = icon + '<span>' + label + '</span>';
        }

        // Update performance chart
        function updatePerformanceChart(metrics) {
            if (!performanceChart || !metrics) return;

            const now = new Date().toLocaleTimeString();
            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push((metrics && metrics.cpu_usage) || 0);

            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
            }

            performanceChart.update();
        }

        // Navigate to module
        function navigateToModule(route) {
            window.location.href = route;
        }

        // Quick actions
        function quickAction(action) {
            socket.emit('module_action', {
                module: 'system',
                action: action
            });

            showNotification(`Executing ${action}...`, 'info');
        }

        // Mount helpers
        function detectMounts() {
            fetch('/api/mounts/detect', { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        const list = (d.data.mounts_found?.mounts_found) || d.data.mounts_found || [];
                        document.getElementById('mountsList').textContent = `Detected mounts: ${Array.isArray(list) ? list.join(', ') : JSON.stringify(list)}`;
                        showNotification('Mounts detection complete', 'success');
                    } else {
                        showNotification('Mount detection unavailable', 'warning');
                    }
                }).catch(() => showNotification('Mount detection failed', 'error'));
        }

        function autoMount() {
            fetch('/api/mounts/auto', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ distance: 150 }) })
                .then(r => r.json())
                .then(d => {
                    if (d.success) showNotification('Auto-mount triggered', 'success');
                    else showNotification('Auto-mount not available', 'warning');
                }).catch(() => showNotification('Auto-mount failed', 'error'));
        }

        // Show system info modal
        function showSystemInfo() {
            // TODO: Implement system info modal
            showNotification('System info feature coming soon!', 'info');
        }

        // Refresh status
        function refreshStatus() {
            socket.emit('get_status');
            showNotification('Refreshing system status...', 'info');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const el = document.createElement('div');
            let color = 'bg-neutral-900 ring-neutral-800';
            if (type === 'success') color = 'bg-green-900/30 ring-green-700/50';
            if (type === 'warning') color = 'bg-yellow-900/30 ring-yellow-700/50';
            if (type === 'error') color = 'bg-red-900/30 ring-red-700/50';
            el.className = `rounded-md px-4 py-3 text-sm text-neutral-200 ring-1 ${color} shadow-lg animate-[fadeIn_.3s_ease]`;
            el.innerHTML = `<div class="flex items-start gap-3"><div class="pt-0.5"><i class="fas fa-info-circle"></i></div><div>${message}</div><button class="ml-auto text-neutral-400 hover:text-neutral-200" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-times"></i></button></div>`;
            container.appendChild(el);
            setTimeout(() => { if (el.parentElement) el.remove(); }, 4500);
        }

        // Request status update every 30 seconds
        setInterval(() => { socket.emit('get_status'); }, 30000);
    </script>
</body>

</html>