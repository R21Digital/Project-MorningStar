<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Insights - Vendor History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .transaction-card {
            transition: transform 0.2s;
        }
        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .price-trend-rising { color: #28a745; }
        .price-trend-falling { color: #dc3545; }
        .price-trend-stable { color: #6c757d; }
        .underpriced { background-color: #d4edda; border-color: #c3e6cb; }
        .overpriced { background-color: #f8d7da; border-color: #f5c6cb; }
        .duplicate-entry { background-color: #fff3cd; border-color: #ffeaa7; }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .search-highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white p-3 mb-4">
            <div class="col">
                <h1><i class="bi bi-shop"></i> Market Insights - Vendor Transaction Ledger</h1>
                <p class="mb-0">Track and analyze all vendor interactions, prices, and market trends</p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4" id="statistics-cards">
            <div class="col-md-3">
                <div class="stats-card">
                    <h4><i class="bi bi-cart"></i> Total Transactions</h4>
                    <h2 id="total-transactions">-</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h4><i class="bi bi-box"></i> Unique Items</h4>
                    <h2 id="unique-items">-</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h4><i class="bi bi-people"></i> Unique Sellers</h4>
                    <h2 id="unique-sellers">-</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h4><i class="bi bi-geo-alt"></i> Locations</h4>
                    <h2 id="unique-locations">-</h2>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filter-section">
            <h4><i class="bi bi-funnel"></i> Filters</h4>
            <div class="row">
                <div class="col-md-3">
                    <label for="item-filter" class="form-label">Item Name</label>
                    <input type="text" class="form-control" id="item-filter" placeholder="Search items...">
                </div>
                <div class="col-md-3">
                    <label for="seller-filter" class="form-label">Seller</label>
                    <input type="text" class="form-control" id="seller-filter" placeholder="Search sellers...">
                </div>
                <div class="col-md-3">
                    <label for="location-filter" class="form-label">Location</label>
                    <input type="text" class="form-control" id="location-filter" placeholder="Search locations...">
                </div>
                <div class="col-md-3">
                    <label for="category-filter" class="form-label">Category</label>
                    <select class="form-select" id="category-filter">
                        <option value="">All Categories</option>
                        <option value="weapon">Weapon</option>
                        <option value="armor">Armor</option>
                        <option value="supply">Supply</option>
                        <option value="ammo">Ammo</option>
                        <option value="tool">Tool</option>
                        <option value="resource">Resource</option>
                        <option value="consumable">Consumable</option>
                        <option value="decoration">Decoration</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-3">
                    <label for="price-min" class="form-label">Min Price</label>
                    <input type="number" class="form-control" id="price-min" placeholder="Min price">
                </div>
                <div class="col-md-3">
                    <label for="price-max" class="form-label">Max Price</label>
                    <input type="number" class="form-control" id="price-max" placeholder="Max price">
                </div>
                <div class="col-md-3">
                    <label for="date-start" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="date-start">
                </div>
                <div class="col-md-3">
                    <label for="date-end" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="date-end">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="bi bi-search"></i> Apply Filters
                    </button>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Special Filters -->
        <div class="row mb-3">
            <div class="col">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-warning" onclick="showUnderpriced()">
                        <i class="bi bi-arrow-down-circle"></i> Underpriced Items
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="showOverpriced()">
                        <i class="bi bi-arrow-up-circle"></i> Overpriced Items
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="showDuplicates()">
                        <i class="bi bi-exclamation-triangle"></i> Duplicate Entries
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="showAll()">
                        <i class="bi bi-list"></i> Show All
                    </button>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-table"></i> Vendor Transactions</h5>
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="transaction-count">Loading...</span>
                            <div>
                                <select class="form-select form-select-sm" id="sort-by" onchange="sortTransactions()">
                                    <option value="timestamp">Sort by Date</option>
                                    <option value="item_name">Sort by Item</option>
                                    <option value="price">Sort by Price</option>
                                    <option value="seller">Sort by Seller</option>
                                    <option value="location">Sort by Location</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Price</th>
                                        <th>Location</th>
                                        <th>Seller</th>
                                        <th>Category</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-tbody">
                                    <tr>
                                        <td colspan="8" class="text-center">Loading transactions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Price Analysis Modal -->
        <div class="modal fade" id="priceAnalysisModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Price Analysis</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="price-analysis-content">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let allTransactions = [];
        let filteredTransactions = [];
        let currentFilters = {};

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadTransactions();
        });

        function loadStatistics() {
            fetch('/api/vendor-ledger/statistics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('total-transactions').textContent = data.statistics.total_transactions;
                        document.getElementById('unique-items').textContent = data.statistics.unique_items;
                        document.getElementById('unique-sellers').textContent = data.statistics.unique_sellers;
                        document.getElementById('unique-locations').textContent = data.statistics.unique_locations;
                    }
                })
                .catch(error => console.error('Error loading statistics:', error));
        }

        function loadTransactions() {
            fetch('/api/vendor-ledger/transactions')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allTransactions = data.transactions;
                        filteredTransactions = [...allTransactions];
                        displayTransactions();
                        updateTransactionCount();
                    }
                })
                .catch(error => console.error('Error loading transactions:', error));
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactions-tbody');
            tbody.innerHTML = '';

            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No transactions found</td></tr>';
                return;
            }

            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'transaction-card';
                
                // Add special classes for underpriced/overpriced items
                if (transaction.price_analysis && transaction.price_analysis.underpriced) {
                    row.classList.add('underpriced');
                } else if (transaction.price_analysis && transaction.price_analysis.overpriced) {
                    row.classList.add('overpriced');
                }

                row.innerHTML = `
                    <td>
                        <strong>${highlightSearch(transaction.item_name)}</strong>
                        ${transaction.quantity > 1 ? `<span class="badge bg-secondary">x${transaction.quantity}</span>` : ''}
                    </td>
                    <td>
                        <span class="fw-bold">${formatPrice(transaction.price)}</span>
                        ${transaction.price_analysis ? `<br><small class="text-muted">Avg: ${formatPrice(transaction.price_analysis.average_price)}</small>` : ''}
                    </td>
                    <td>${highlightSearch(transaction.location)}</td>
                    <td>${highlightSearch(transaction.seller)}</td>
                    <td><span class="badge bg-info">${transaction.item_category}</span></td>
                    <td><span class="badge bg-primary">${transaction.transaction_type}</span></td>
                    <td>${formatDate(transaction.timestamp)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showPriceAnalysis('${transaction.item_name}')">
                            <i class="bi bi-graph-up"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="showTransactionDetails('${transaction.timestamp}')">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function highlightSearch(text) {
            const searchTerm = document.getElementById('item-filter').value.toLowerCase();
            if (searchTerm && text.toLowerCase().includes(searchTerm)) {
                return text.replace(new RegExp(searchTerm, 'gi'), match => `<span class="search-highlight">${match}</span>`);
            }
            return text;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat().format(price);
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        function updateTransactionCount() {
            document.getElementById('transaction-count').textContent = 
                `Showing ${filteredTransactions.length} of ${allTransactions.length} transactions`;
        }

        function applyFilters() {
            const itemFilter = document.getElementById('item-filter').value.toLowerCase();
            const sellerFilter = document.getElementById('seller-filter').value.toLowerCase();
            const locationFilter = document.getElementById('location-filter').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const priceMin = document.getElementById('price-min').value;
            const priceMax = document.getElementById('price-max').value;
            const dateStart = document.getElementById('date-start').value;
            const dateEnd = document.getElementById('date-end').value;

            currentFilters = {
                item_name: itemFilter,
                seller: sellerFilter,
                location: locationFilter,
                item_category: categoryFilter,
                min_price: priceMin ? parseInt(priceMin) : null,
                max_price: priceMax ? parseInt(priceMax) : null,
                start_date: dateStart,
                end_date: dateEnd
            };

            filteredTransactions = allTransactions.filter(transaction => {
                if (itemFilter && !transaction.item_name.toLowerCase().includes(itemFilter)) return false;
                if (sellerFilter && !transaction.seller.toLowerCase().includes(sellerFilter)) return false;
                if (locationFilter && !transaction.location.toLowerCase().includes(locationFilter)) return false;
                if (categoryFilter && transaction.item_category !== categoryFilter) return false;
                if (priceMin && transaction.price < parseInt(priceMin)) return false;
                if (priceMax && transaction.price > parseInt(priceMax)) return false;
                if (dateStart && transaction.timestamp < dateStart) return false;
                if (dateEnd && transaction.timestamp > dateEnd) return false;
                return true;
            });

            displayTransactions();
            updateTransactionCount();
        }

        function clearFilters() {
            document.getElementById('item-filter').value = '';
            document.getElementById('seller-filter').value = '';
            document.getElementById('location-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('price-min').value = '';
            document.getElementById('price-max').value = '';
            document.getElementById('date-start').value = '';
            document.getElementById('date-end').value = '';
            
            currentFilters = {};
            filteredTransactions = [...allTransactions];
            displayTransactions();
            updateTransactionCount();
        }

        function showUnderpriced() {
            fetch('/api/vendor-ledger/underpriced')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        filteredTransactions = data.transactions;
                        displayTransactions();
                        updateTransactionCount();
                    }
                })
                .catch(error => console.error('Error loading underpriced items:', error));
        }

        function showOverpriced() {
            fetch('/api/vendor-ledger/overpriced')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        filteredTransactions = data.transactions;
                        displayTransactions();
                        updateTransactionCount();
                    }
                })
                .catch(error => console.error('Error loading overpriced items:', error));
        }

        function showDuplicates() {
            fetch('/api/vendor-ledger/duplicates')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        filteredTransactions = data.transactions;
                        displayTransactions();
                        updateTransactionCount();
                    }
                })
                .catch(error => console.error('Error loading duplicate entries:', error));
        }

        function showAll() {
            filteredTransactions = [...allTransactions];
            displayTransactions();
            updateTransactionCount();
        }

        function sortTransactions() {
            const sortBy = document.getElementById('sort-by').value;
            filteredTransactions.sort((a, b) => {
                switch (sortBy) {
                    case 'item_name':
                        return a.item_name.localeCompare(b.item_name);
                    case 'price':
                        return a.price - b.price;
                    case 'seller':
                        return a.seller.localeCompare(b.seller);
                    case 'location':
                        return a.location.localeCompare(b.location);
                    case 'timestamp':
                    default:
                        return new Date(b.timestamp) - new Date(a.timestamp);
                }
            });
            displayTransactions();
        }

        function showPriceAnalysis(itemName) {
            fetch(`/api/vendor-ledger/price-analysis/${encodeURIComponent(itemName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = new bootstrap.Modal(document.getElementById('priceAnalysisModal'));
                        document.getElementById('price-analysis-content').innerHTML = createPriceAnalysisHTML(data.analysis);
                        modal.show();
                    }
                })
                .catch(error => console.error('Error loading price analysis:', error));
        }

        function createPriceAnalysisHTML(analysis) {
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Price Statistics</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Average Price:</span>
                                <strong>${formatPrice(analysis.analysis.average_price)}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Median Price:</span>
                                <strong>${formatPrice(analysis.analysis.median_price)}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Min Price:</span>
                                <strong>${formatPrice(analysis.analysis.min_price)}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Max Price:</span>
                                <strong>${formatPrice(analysis.analysis.max_price)}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Price Count:</span>
                                <strong>${analysis.analysis.price_count}</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Price Trend</h6>
                        <p class="price-trend-${analysis.analysis.price_trend}">
                            <i class="bi bi-arrow-${analysis.analysis.price_trend === 'rising' ? 'up' : analysis.analysis.price_trend === 'falling' ? 'down' : 'right'}"></i>
                            ${analysis.analysis.price_trend.charAt(0).toUpperCase() + analysis.analysis.price_trend.slice(1)}
                        </p>
                        <h6>Seller Averages</h6>
                        <ul class="list-group">
                            ${Object.entries(analysis.seller_averages).map(([seller, avg]) => 
                                `<li class="list-group-item d-flex justify-content-between">
                                    <span>${seller}:</span>
                                    <strong>${formatPrice(avg)}</strong>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        function showTransactionDetails(timestamp) {
            const transaction = filteredTransactions.find(t => t.timestamp === timestamp);
            if (transaction) {
                alert(`Transaction Details:\nItem: ${transaction.item_name}\nPrice: ${formatPrice(transaction.price)}\nSeller: ${transaction.seller}\nLocation: ${transaction.location}\nDate: ${formatDate(transaction.timestamp)}`);
            }
        }

        function exportData() {
            const data = {
                transactions: filteredTransactions,
                filters: currentFilters,
                export_date: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vendor_transactions_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 