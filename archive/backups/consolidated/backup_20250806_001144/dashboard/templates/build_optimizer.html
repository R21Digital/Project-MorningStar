{% extends "base.html" %}

{% block title %}Build Optimizer - SWGDB{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-cogs"></i> Build Optimizer
            </h1>
            <p class="lead">Input your character stats to get AI-generated recommendations for professions, buffs, food, armor, weapons, and stat reallocations.</p>
        </div>
    </div>

    <!-- Character Stats Input Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user"></i> Character Statistics</h5>
                </div>
                <div class="card-body">
                    <form id="buildOptimizerForm">
                        <!-- Primary Stats -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">Primary Stats</h6>
                            </div>
                            <div class="col-md-4">
                                <label for="health" class="form-label">Health</label>
                                <input type="number" class="form-control" id="health" name="health" min="0" max="1000" value="100">
                            </div>
                            <div class="col-md-4">
                                <label for="action" class="form-label">Action</label>
                                <input type="number" class="form-control" id="action" name="action" min="0" max="1000" value="100">
                            </div>
                            <div class="col-md-4">
                                <label for="mind" class="form-label">Mind</label>
                                <input type="number" class="form-control" id="mind" name="mind" min="0" max="1000" value="100">
                            </div>
                        </div>

                        <!-- Secondary Stats -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">Secondary Stats</h6>
                            </div>
                            <div class="col-md-3">
                                <label for="strength" class="form-label">Strength</label>
                                <input type="number" class="form-control" id="strength" name="strength" min="0" max="100" value="25">
                            </div>
                            <div class="col-md-3">
                                <label for="constitution" class="form-label">Constitution</label>
                                <input type="number" class="form-control" id="constitution" name="constitution" min="0" max="100" value="25">
                            </div>
                            <div class="col-md-3">
                                <label for="agility" class="form-label">Agility</label>
                                <input type="number" class="form-control" id="agility" name="agility" min="0" max="100" value="25">
                            </div>
                            <div class="col-md-3">
                                <label for="quickness" class="form-label">Quickness</label>
                                <input type="number" class="form-control" id="quickness" name="quickness" min="0" max="100" value="25">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label for="stamina" class="form-label">Stamina</label>
                                <input type="number" class="form-control" id="stamina" name="stamina" min="0" max="100" value="25">
                            </div>
                            <div class="col-md-3">
                                <label for="presence" class="form-label">Presence</label>
                                <input type="number" class="form-control" id="presence" name="presence" min="0" max="100" value="25">
                            </div>
                            <div class="col-md-3">
                                <label for="focus" class="form-label">Focus</label>
                                <input type="number" class="form-control" id="focus" name="focus" min="0" max="100" value="25">
                            </div>
                            <div class="col-md-3">
                                <label for="willpower" class="form-label">Willpower</label>
                                <input type="number" class="form-control" id="willpower" name="willpower" min="0" max="100" value="25">
                            </div>
                        </div>

                        <!-- Character Context -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">Character Context</h6>
                            </div>
                            <div class="col-md-4">
                                <label for="combat_role" class="form-label">Combat Role</label>
                                <select class="form-select" id="combat_role" name="combat_role">
                                    <option value="dps">DPS</option>
                                    <option value="tank">Tank</option>
                                    <option value="support">Support</option>
                                    <option value="hybrid">Hybrid</option>
                                    <option value="pvp">PVP</option>
                                    <option value="pve">PVE</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="level" class="form-label">Level</label>
                                <input type="number" class="form-control" id="level" name="level" min="1" max="90" value="10">
                            </div>
                            <div class="col-md-4">
                                <label for="current_profession" class="form-label">Current Profession</label>
                                <input type="text" class="form-control" id="current_profession" name="current_profession" placeholder="Optional">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="respec_available" name="respec_available">
                                    <label class="form-check-label" for="respec_available">
                                        Respec Available
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-magic"></i> Analyze Build
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg ms-2" id="loadSampleData">
                                    <i class="fas fa-download"></i> Load Sample Data
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg ms-2" id="saveBuild">
                                    <i class="fas fa-save"></i> Save Build
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Quick Stats Summary -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Stats Summary</h5>
                </div>
                <div class="card-body">
                    <div id="statsSummary">
                        <p class="text-muted">Enter your stats to see a summary here.</p>
                    </div>
                </div>
            </div>

            <!-- Saved Builds -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-bookmark"></i> Saved Builds</h5>
                </div>
                <div class="card-body">
                    <div id="savedBuilds">
                        <p class="text-muted">No saved builds yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="row mt-4" id="analysisResults" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Build Analysis Results</h5>
                </div>
                <div class="card-body">
                    <!-- Overall Score -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-star"></i> Overall Build Score</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar" id="overallScoreBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <span id="overallScoreText">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-light">
                                <h6><i class="fas fa-info-circle"></i> Analysis Summary</h6>
                                <p id="analysisSummary" class="mb-0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations by Category -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-user-graduate"></i> Profession Recommendations</h6>
                                </div>
                                <div class="card-body">
                                    <div id="professionRecommendations"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-shield-alt"></i> Equipment Recommendations</h6>
                                </div>
                                <div class="card-body">
                                    <div id="equipmentRecommendations"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-magic"></i> Buff & Food Recommendations</h6>
                                </div>
                                <div class="card-body">
                                    <div id="buffRecommendations"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-exchange-alt"></i> Stat Reallocation</h6>
                                </div>
                                <div class="card-body">
                                    <div id="reallocationRecommendations"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendation Detail Modal -->
<div class="modal fade" id="recommendationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recommendationModalTitle">Recommendation Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recommendationModalBody">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('buildOptimizerForm');
    const analysisResults = document.getElementById('analysisResults');
    const loadSampleBtn = document.getElementById('loadSampleData');
    const saveBuildBtn = document.getElementById('saveBuild');
    const statsSummary = document.getElementById('statsSummary');

    // Load sample data
    loadSampleBtn.addEventListener('click', function() {
        const sampleData = {
            health: 150,
            action: 120,
            mind: 80,
            strength: 45,
            constitution: 35,
            agility: 40,
            quickness: 35,
            stamina: 30,
            presence: 25,
            focus: 30,
            willpower: 25,
            combat_role: 'dps',
            level: 15,
            current_profession: 'rifleman',
            respec_available: false
        };

        // Populate form fields
        Object.keys(sampleData).forEach(key => {
            const field = document.getElementById(key);
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = sampleData[key];
                } else {
                    field.value = sampleData[key];
                }
            }
        });

        updateStatsSummary();
    });

    // Save build
    saveBuildBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        const buildData = Object.fromEntries(formData.entries());
        
        // Add timestamp
        buildData.timestamp = new Date().toISOString();
        buildData.name = `Build ${new Date().toLocaleDateString()}`;

        // Save to localStorage
        const savedBuilds = JSON.parse(localStorage.getItem('savedBuilds') || '[]');
        savedBuilds.push(buildData);
        localStorage.setItem('savedBuilds', JSON.stringify(savedBuilds));

        updateSavedBuilds();
        showAlert('Build saved successfully!', 'success');
    });

    // Update stats summary
    function updateStatsSummary() {
        const formData = new FormData(form);
        const stats = Object.fromEntries(formData.entries());
        
        const totalStats = parseInt(stats.strength || 0) + parseInt(stats.constitution || 0) + 
                          parseInt(stats.agility || 0) + parseInt(stats.quickness || 0) + 
                          parseInt(stats.stamina || 0) + parseInt(stats.presence || 0) + 
                          parseInt(stats.focus || 0) + parseInt(stats.willpower || 0);

        statsSummary.innerHTML = `
            <div class="row">
                <div class="col-6">
                    <small class="text-muted">Primary Stats</small><br>
                    <strong>Health:</strong> ${stats.health || 0}<br>
                    <strong>Action:</strong> ${stats.action || 0}<br>
                    <strong>Mind:</strong> ${stats.mind || 0}
                </div>
                <div class="col-6">
                    <small class="text-muted">Secondary Stats</small><br>
                    <strong>Total:</strong> ${totalStats}<br>
                    <strong>Average:</strong> ${Math.round(totalStats / 8)}<br>
                    <strong>Level:</strong> ${stats.level || 1}
                </div>
            </div>
        `;
    }

    // Update saved builds display
    function updateSavedBuilds() {
        const savedBuilds = JSON.parse(localStorage.getItem('savedBuilds') || '[]');
        const container = document.getElementById('savedBuilds');
        
        if (savedBuilds.length === 0) {
            container.innerHTML = '<p class="text-muted">No saved builds yet.</p>';
            return;
        }

        let html = '';
        savedBuilds.forEach((build, index) => {
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>${build.name}</strong><br>
                        <small class="text-muted">Level ${build.level} ${build.combat_role}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadBuild(${index})">
                        <i class="fas fa-upload"></i>
                    </button>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // Load a saved build
    window.loadBuild = function(index) {
        const savedBuilds = JSON.parse(localStorage.getItem('savedBuilds') || '[]');
        const build = savedBuilds[index];
        
        if (build) {
            Object.keys(build).forEach(key => {
                const field = document.getElementById(key);
                if (field && key !== 'timestamp' && key !== 'name') {
                    if (field.type === 'checkbox') {
                        field.checked = build[key] === 'true' || build[key] === true;
                    } else {
                        field.value = build[key];
                    }
                }
            });
            
            updateStatsSummary();
            showAlert('Build loaded successfully!', 'success');
        }
    };

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const stats = Object.fromEntries(formData.entries());
        
        // Convert numeric values
        Object.keys(stats).forEach(key => {
            if (stats[key] !== '' && !isNaN(stats[key])) {
                stats[key] = parseInt(stats[key]);
            }
        });

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        submitBtn.disabled = true;

        // Send analysis request
        fetch('/api/build-optimizer/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(stats)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('Error: ' + data.error, 'danger');
            } else {
                displayAnalysisResults(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error analyzing build. Please try again.', 'danger');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    // Display analysis results
    function displayAnalysisResults(data) {
        // Show results section
        analysisResults.style.display = 'block';
        
        // Update overall score
        const scorePercent = Math.round(data.total_score * 100);
        document.getElementById('overallScoreBar').style.width = scorePercent + '%';
        document.getElementById('overallScoreBar').textContent = scorePercent + '%';
        document.getElementById('overallScoreText').textContent = scorePercent + '%';
        
        // Update summary
        document.getElementById('analysisSummary').textContent = data.summary;
        
        // Display recommendations by category
        displayRecommendations('professionRecommendations', data.recommendations.filter(r => r.recommendation_type === 'profession'));
        displayRecommendations('equipmentRecommendations', data.recommendations.filter(r => r.recommendation_type === 'armor' || r.recommendation_type === 'weapon'));
        displayRecommendations('buffRecommendations', data.recommendations.filter(r => r.recommendation_type === 'buff' || r.recommendation_type === 'food'));
        displayRecommendations('reallocationRecommendations', data.recommendations.filter(r => r.recommendation_type === 'stat_reallocation'));
        
        // Scroll to results
        analysisResults.scrollIntoView({ behavior: 'smooth' });
    }

    // Display recommendations for a category
    function displayRecommendations(containerId, recommendations) {
        const container = document.getElementById(containerId);
        
        if (recommendations.length === 0) {
            container.innerHTML = '<p class="text-muted">No recommendations available.</p>';
            return;
        }

        let html = '';
        recommendations.forEach((rec, index) => {
            const scorePercent = Math.round(rec.score * 100);
            html += `
                <div class="recommendation-item mb-3 p-3 border rounded" onclick="showRecommendationDetails(${JSON.stringify(rec).replace(/"/g, '&quot;')})">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${rec.name}</h6>
                            <p class="text-muted mb-2">${rec.description}</p>
                            <small class="text-muted">${rec.reasoning}</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-primary">${scorePercent}%</div>
                            ${rec.cost ? `<br><small class="text-muted">${rec.cost} credits</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // Show recommendation details modal
    window.showRecommendationDetails = function(recommendation) {
        const modal = new bootstrap.Modal(document.getElementById('recommendationModal'));
        const title = document.getElementById('recommendationModalTitle');
        const body = document.getElementById('recommendationModalBody');
        
        title.textContent = recommendation.name;
        
        let html = `
            <div class="row">
                <div class="col-md-8">
                    <h6>Description</h6>
                    <p>${recommendation.description}</p>
                    
                    <h6>Reasoning</h6>
                    <p>${recommendation.reasoning}</p>
                </div>
                <div class="col-md-4">
                    <h6>Score</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar" style="width: ${Math.round(recommendation.score * 100)}%"></div>
                    </div>
                    <span>${Math.round(recommendation.score * 100)}%</span>
                </div>
            </div>
        `;
        
        if (recommendation.benefits && recommendation.benefits.length > 0) {
            html += `
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Benefits</h6>
                        <ul class="list-unstyled">
                            ${recommendation.benefits.map(benefit => `<li><i class="fas fa-check text-success"></i> ${benefit}</li>`).join('')}
                        </ul>
                    </div>
                    ${recommendation.drawbacks && recommendation.drawbacks.length > 0 ? `
                    <div class="col-md-6">
                        <h6>Drawbacks</h6>
                        <ul class="list-unstyled">
                            ${recommendation.drawbacks.map(drawback => `<li><i class="fas fa-times text-danger"></i> ${drawback}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        if (recommendation.cost) {
            html += `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Cost</h6>
                        <p class="mb-0"><i class="fas fa-coins"></i> ${recommendation.cost} credits</p>
                    </div>
                </div>
            `;
        }
        
        body.innerHTML = html;
        modal.show();
    };

    // Update stats summary when form changes
    form.addEventListener('input', updateStatsSummary);
    
    // Initialize
    updateStatsSummary();
    updateSavedBuilds();
});
</script>
{% endblock %} 