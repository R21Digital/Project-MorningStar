<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Encounters - MS11</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .main-container {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .content-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .player-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .player-card:hover {
            transform: translateY(-2px);
        }
        .encounter-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        .search-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .filter-badge {
            background: #e9ecef;
            color: #495057;
            padding: 5px 10px;
            border-radius: 20px;
            margin: 2px;
            display: inline-block;
        }
        .species-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .guild-badge {
            background: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .faction-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
        }
        .faction-rebel { background: #dc3545; }
        .faction-imperial { background: #6c757d; }
        .faction-neutral { background: #28a745; }
        .faction-hutt { background: #fd7e14; }
        .faction-mandalorian { background: #6f42c1; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .tab-content {
            padding: 20px 0;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            border-radius: 0;
        }
        .nav-tabs .nav-link.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            background: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot"></i> MS11 Player Encounters
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link active" href="/player-encounters">Player Encounters</a>
                <a class="nav-link" href="/build-showcase">Build Showcase</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Header Section -->
        <div class="content-card">
            <div class="row">
                <div class="col-md-8">
                    <h1><i class="fas fa-users"></i> Player Encounters</h1>
                    <p class="text-muted">Track and analyze player encounters during MS11 sessions</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary" onclick="triggerScan()">
                        <i class="fas fa-search"></i> Scan Now
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row" id="statsContainer">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="totalPlayers">-</h3>
                    <p>Total Players</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="totalEncounters">-</h3>
                    <p>Total Encounters</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="uniqueGuilds">-</h3>
                    <p>Unique Guilds</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="activeToday">-</h3>
                    <p>Active Today</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search players, guilds, or locations...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="speciesFilter">
                        <option value="">All Species</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="factionFilter">
                        <option value="">All Factions</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <div id="activeFilters"></div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="content-card">
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab">
                        <i class="fas fa-users"></i> Players
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="encounters-tab" data-bs-toggle="tab" data-bs-target="#encounters" type="button" role="tab">
                        <i class="fas fa-history"></i> Encounters
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="screenshots-tab" data-bs-toggle="tab" data-bs-target="#screenshots" type="button" role="tab">
                        <i class="fas fa-camera"></i> Screenshots
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <!-- Players Tab -->
                <div class="tab-pane fade show active" id="players" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Known Players</h4>
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="playerSort">
                                <option value="name">Sort by Name</option>
                                <option value="encounter_count">Sort by Encounters</option>
                                <option value="last_seen">Sort by Last Seen</option>
                                <option value="first_seen">Sort by First Seen</option>
                            </select>
                        </div>
                    </div>
                    <div id="playersContainer" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading players...
                    </div>
                </div>

                <!-- Encounters Tab -->
                <div class="tab-pane fade" id="encounters" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Recent Encounters</h4>
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="encounterSort">
                                <option value="timestamp">Sort by Time</option>
                                <option value="player_name">Sort by Player</option>
                                <option value="planet">Sort by Planet</option>
                            </select>
                        </div>
                    </div>
                    <div id="encountersContainer" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading encounters...
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Species Distribution</h4>
                            <div class="chart-container">
                                <canvas id="speciesChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4>Faction Distribution</h4>
                            <div class="chart-container">
                                <canvas id="factionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h4>Most Encountered Players</h4>
                            <div id="topPlayersContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- Screenshots Tab -->
                <div class="tab-pane fade" id="screenshots" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Encounter Screenshots</h4>
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="screenshotPlayer">
                                <option value="">All Players</option>
                            </select>
                        </div>
                    </div>
                    <div id="screenshotsContainer" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading screenshots...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div class="modal fade" id="playerDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playerDetailTitle">Player Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="playerDetailContent">
                    <!-- Player details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        class PlayerEncounters {
            constructor() {
                this.currentTab = 'players';
                this.players = [];
                this.encounters = [];
                this.statistics = {};
                this.filters = {
                    search: '',
                    species: '',
                    faction: ''
                };
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadStatistics();
                await this.loadPlayers();
                await this.loadEncounters();
                this.setupCharts();
            }

            setupEventListeners() {
                // Search and filter events
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filters.search = e.target.value;
                    this.applyFilters();
                });

                document.getElementById('speciesFilter').addEventListener('change', (e) => {
                    this.filters.species = e.target.value;
                    this.applyFilters();
                });

                document.getElementById('factionFilter').addEventListener('change', (e) => {
                    this.filters.faction = e.target.value;
                    this.applyFilters();
                });

                // Sort events
                document.getElementById('playerSort').addEventListener('change', (e) => {
                    this.sortPlayers(e.target.value);
                });

                document.getElementById('encounterSort').addEventListener('change', (e) => {
                    this.sortEncounters(e.target.value);
                });

                // Tab events
                document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                    tab.addEventListener('shown.bs.tab', (e) => {
                        this.currentTab = e.target.getAttribute('data-bs-target').substring(1);
                        if (this.currentTab === 'analytics') {
                            this.updateCharts();
                        }
                    });
                });
            }

            async loadStatistics() {
                try {
                    const response = await fetch('/api/player-encounters/statistics');
                    this.statistics = await response.json();
                    this.updateStatistics();
                } catch (error) {
                    console.error('Failed to load statistics:', error);
                }
            }

            async loadPlayers() {
                try {
                    const response = await fetch('/api/player-encounters/players?limit=1000');
                    const data = await response.json();
                    this.players = data.players;
                    this.renderPlayers();
                    this.populateFilters();
                } catch (error) {
                    console.error('Failed to load players:', error);
                }
            }

            async loadEncounters() {
                try {
                    const response = await fetch('/api/player-encounters?limit=1000');
                    const data = await response.json();
                    this.encounters = data.encounters;
                    this.renderEncounters();
                } catch (error) {
                    console.error('Failed to load encounters:', error);
                }
            }

            updateStatistics() {
                document.getElementById('totalPlayers').textContent = this.statistics.total_players || 0;
                document.getElementById('totalEncounters').textContent = this.statistics.total_encounters || 0;
                document.getElementById('uniqueGuilds').textContent = Object.keys(this.statistics.guild_statistics || {}).length;
                document.getElementById('activeToday').textContent = this.getActiveToday();
            }

            getActiveToday() {
                const today = new Date().toISOString().split('T')[0];
                return this.players.filter(p => p.last_seen && p.last_seen.startsWith(today)).length;
            }

            renderPlayers() {
                const container = document.getElementById('playersContainer');
                if (this.players.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No players found</div>';
                    return;
                }

                container.innerHTML = this.players.map(player => this.createPlayerCard(player)).join('');
            }

            createPlayerCard(player) {
                const speciesIcon = this.getSpeciesIcon(player.species);
                const factionBadge = player.faction ? `<span class="faction-badge faction-${player.faction.toLowerCase()}">${player.faction}</span>` : '';
                const guildBadge = player.guild ? `<span class="guild-badge">${player.guild}</span>` : '';

                return `
                    <div class="player-card" onclick="playerEncounters.showPlayerDetail('${player.name}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="mb-1">
                                    ${speciesIcon}
                                    ${player.name}
                                    ${factionBadge}
                                    ${guildBadge}
                                </h5>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-map-marker-alt"></i> ${player.location?.planet || 'Unknown'} - ${player.location?.city || 'Unknown'}
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-clock"></i> Last seen: ${this.formatDate(player.last_seen)}
                                </p>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-primary">${player.encounter_count} encounters</div>
                                ${player.title ? `<div class="badge bg-secondary mt-1">${player.title}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderEncounters() {
                const container = document.getElementById('encountersContainer');
                if (this.encounters.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No encounters found</div>';
                    return;
                }

                container.innerHTML = this.encounters.map(encounter => this.createEncounterItem(encounter)).join('');
            }

            createEncounterItem(encounter) {
                const speciesIcon = this.getSpeciesIcon(encounter.species);
                const factionBadge = encounter.faction ? `<span class="faction-badge faction-${encounter.faction.toLowerCase()}">${encounter.faction}</span>` : '';
                const guildBadge = encounter.guild ? `<span class="guild-badge">${encounter.guild}</span>` : '';

                return `
                    <div class="encounter-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    ${speciesIcon}
                                    ${encounter.player_name}
                                    ${factionBadge}
                                    ${guildBadge}
                                </h6>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-map-marker-alt"></i> ${encounter.planet} - ${encounter.city}
                                    ${encounter.coordinates ? `(${encounter.coordinates[0]}, ${encounter.coordinates[1]})` : ''}
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-clock"></i> ${this.formatDate(encounter.timestamp)}
                                    <span class="ms-2"><i class="fas fa-eye"></i> ${Math.round(encounter.confidence)}% confidence</span>
                                </p>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-info">${encounter.encounter_type}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getSpeciesIcon(species) {
                const icons = {
                    'human': 'fas fa-user',
                    'wookiee': 'fas fa-paw',
                    'rodian': 'fas fa-user-astronaut',
                    'twilek': 'fas fa-user-tie',
                    'mon_calamari': 'fas fa-fish',
                    'sullustan': 'fas fa-user-circle',
                    'trandoshan': 'fas fa-dragon',
                    'zabrak': 'fas fa-user-ninja',
                    'ithorian': 'fas fa-user-graduate',
                    'geonosian': 'fas fa-bug',
                    'bothan': 'fas fa-user-secret'
                };
                const icon = icons[species] || 'fas fa-user';
                return `<i class="${icon} species-icon"></i>`;
            }

            formatDate(dateString) {
                if (!dateString) return 'Unknown';
                const date = new Date(dateString);
                return date.toLocaleString();
            }

            populateFilters() {
                const species = [...new Set(this.players.map(p => p.species).filter(Boolean))];
                const factions = [...new Set(this.players.map(p => p.faction).filter(Boolean))];

                const speciesFilter = document.getElementById('speciesFilter');
                species.forEach(species => {
                    const option = document.createElement('option');
                    option.value = species;
                    option.textContent = species;
                    speciesFilter.appendChild(option);
                });

                const factionFilter = document.getElementById('factionFilter');
                factions.forEach(faction => {
                    const option = document.createElement('option');
                    option.value = faction;
                    option.textContent = faction;
                    factionFilter.appendChild(option);
                });
            }

            applyFilters() {
                // Update active filters display
                const activeFilters = document.getElementById('activeFilters');
                const filters = [];
                
                if (this.filters.search) filters.push(`Search: "${this.filters.search}"`);
                if (this.filters.species) filters.push(`Species: ${this.filters.species}`);
                if (this.filters.faction) filters.push(`Faction: ${this.filters.faction}`);
                
                activeFilters.innerHTML = filters.map(f => `<span class="filter-badge">${f}</span>`).join('');

                // Apply filters to current view
                if (this.currentTab === 'players') {
                    this.filterPlayers();
                } else if (this.currentTab === 'encounters') {
                    this.filterEncounters();
                }
            }

            filterPlayers() {
                const filtered = this.players.filter(player => {
                    if (this.filters.search) {
                        const searchLower = this.filters.search.toLowerCase();
                        if (!player.name.toLowerCase().includes(searchLower) &&
                            !(player.guild && player.guild.toLowerCase().includes(searchLower)) &&
                            !(player.location && player.location.planet && player.location.planet.toLowerCase().includes(searchLower))) {
                            return false;
                        }
                    }
                    if (this.filters.species && player.species !== this.filters.species) return false;
                    if (this.filters.faction && player.faction !== this.filters.faction) return false;
                    return true;
                });

                const container = document.getElementById('playersContainer');
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No players match the filters</div>';
                } else {
                    container.innerHTML = filtered.map(player => this.createPlayerCard(player)).join('');
                }
            }

            filterEncounters() {
                const filtered = this.encounters.filter(encounter => {
                    if (this.filters.search) {
                        const searchLower = this.filters.search.toLowerCase();
                        if (!encounter.player_name.toLowerCase().includes(searchLower) &&
                            !(encounter.guild && encounter.guild.toLowerCase().includes(searchLower)) &&
                            !encounter.planet.toLowerCase().includes(searchLower)) {
                            return false;
                        }
                    }
                    if (this.filters.species && encounter.species !== this.filters.species) return false;
                    if (this.filters.faction && encounter.faction !== this.filters.faction) return false;
                    return true;
                });

                const container = document.getElementById('encountersContainer');
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No encounters match the filters</div>';
                } else {
                    container.innerHTML = filtered.map(encounter => this.createEncounterItem(encounter)).join('');
                }
            }

            sortPlayers(sortBy) {
                this.players.sort((a, b) => {
                    switch (sortBy) {
                        case 'encounter_count':
                            return b.encounter_count - a.encounter_count;
                        case 'last_seen':
                            return new Date(b.last_seen) - new Date(a.last_seen);
                        case 'first_seen':
                            return new Date(b.first_seen) - new Date(a.first_seen);
                        default:
                            return a.name.localeCompare(b.name);
                    }
                });
                this.renderPlayers();
            }

            sortEncounters(sortBy) {
                this.encounters.sort((a, b) => {
                    switch (sortBy) {
                        case 'player_name':
                            return a.player_name.localeCompare(b.player_name);
                        case 'planet':
                            return a.planet.localeCompare(b.planet);
                        default:
                            return new Date(b.timestamp) - new Date(a.timestamp);
                    }
                });
                this.renderEncounters();
            }

            setupCharts() {
                this.speciesChart = new Chart(document.getElementById('speciesChart'), {
                    type: 'doughnut',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                this.factionChart = new Chart(document.getElementById('factionChart'), {
                    type: 'doughnut',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            updateCharts() {
                if (!this.statistics.species_statistics) return;

                // Species chart
                const speciesData = this.statistics.species_statistics;
                this.speciesChart.data.labels = Object.keys(speciesData);
                this.speciesChart.data.datasets = [{
                    data: Object.values(speciesData),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }];
                this.speciesChart.update();

                // Faction chart
                const factionData = this.statistics.guild_statistics;
                this.factionChart.data.labels = Object.keys(factionData);
                this.factionChart.data.datasets = [{
                    data: Object.values(factionData),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }];
                this.factionChart.update();

                // Top players
                this.renderTopPlayers();
            }

            renderTopPlayers() {
                const container = document.getElementById('topPlayersContainer');
                if (!this.statistics.most_encountered) return;

                container.innerHTML = this.statistics.most_encountered.map((player, index) => `
                    <div class="player-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    #${index + 1} ${player.name}
                                    ${player.guild ? `<span class="guild-badge">${player.guild}</span>` : ''}
                                </h5>
                                <p class="text-muted mb-0">
                                    ${player.species ? `${player.species} • ` : ''}${player.encounter_count} encounters
                                </p>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-warning">${player.encounter_count} encounters</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async showPlayerDetail(playerName) {
                try {
                    const response = await fetch(`/api/player-encounters/players/${encodeURIComponent(playerName)}`);
                    const player = await response.json();

                    document.getElementById('playerDetailTitle').textContent = player.name;
                    document.getElementById('playerDetailContent').innerHTML = this.createPlayerDetailContent(player);
                    
                    const modal = new bootstrap.Modal(document.getElementById('playerDetailModal'));
                    modal.show();
                } catch (error) {
                    console.error('Failed to load player details:', error);
                }
            }

            createPlayerDetailContent(player) {
                return `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Player Information</h6>
                            <ul class="list-unstyled">
                                <li><strong>Name:</strong> ${player.name}</li>
                                <li><strong>Guild:</strong> ${player.guild || 'None'}</li>
                                <li><strong>Title:</strong> ${player.title || 'None'}</li>
                                <li><strong>Species:</strong> ${player.species || 'Unknown'}</li>
                                <li><strong>Faction:</strong> ${player.faction || 'Unknown'}</li>
                                <li><strong>Profession:</strong> ${player.profession || 'Unknown'}</li>
                                <li><strong>Level:</strong> ${player.level || 'Unknown'}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Encounter Statistics</h6>
                            <ul class="list-unstyled">
                                <li><strong>Total Encounters:</strong> ${player.encounter_count}</li>
                                <li><strong>First Seen:</strong> ${this.formatDate(player.first_seen)}</li>
                                <li><strong>Last Seen:</strong> ${this.formatDate(player.last_seen)}</li>
                                <li><strong>Current Location:</strong> ${player.location?.planet || 'Unknown'} - ${player.location?.city || 'Unknown'}</li>
                            </ul>
                        </div>
                    </div>
                    <hr>
                    <h6>Recent Encounters</h6>
                    <div class="row">
                        ${player.encounters.map(encounter => `
                            <div class="col-md-6 mb-2">
                                <div class="encounter-item">
                                    <strong>${encounter.planet} - ${encounter.city}</strong><br>
                                    <small class="text-muted">${this.formatDate(encounter.timestamp)}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Global functions for button clicks
        async function triggerScan() {
            try {
                const response = await fetch('/api/player-encounters/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: {
                            planet: 'Unknown',
                            city: 'Unknown',
                            coordinates: null
                        }
                    })
                });
                const result = await response.json();
                alert(`Scan completed! Found ${result.encounters_found} encounters.`);
                location.reload();
            } catch (error) {
                console.error('Scan failed:', error);
                alert('Scan failed. Please try again.');
            }
        }

        async function exportData() {
            try {
                window.open('/api/player-encounters/export/json', '_blank');
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
            }
        }

        // Initialize when page loads
        let playerEncounters;
        document.addEventListener('DOMContentLoaded', () => {
            playerEncounters = new PlayerEncounters();
        });
    </script>
</body>
</html> 