<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Heatmap & Popular Paths - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2a5298;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #666;
            text-align: center;
            font-size: 1.1em;
        }

        .admin-badge {
            background: #ff4757;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.4);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f2f6;
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #2a5298;
        }

        .card-subtitle {
            color: #666;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .heatmap-container {
            height: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .heatmap-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 1.2em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .danger-zone {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .popular-path {
            background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .period-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .coordinate-heatmap {
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .heatmap-point {
            position: absolute;
            border-radius: 50%;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .heatmap-point:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #764ba2;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
        
        <div class="header">
            <h1>Quest Heatmap & Popular Paths Tracker <span class="admin-badge">ADMIN</span></h1>
            <p>Visualize quest usage patterns and identify popular areas across all sessions (anonymized data)</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="controls">
            <div class="control-group">
                <a href="/admin/quest-heatmap/process" class="btn btn-primary">Process Session Logs</a>
                <div class="period-selector">
                    <label for="period">Time Period:</label>
                    <select id="period" onchange="updateData()">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>
                <button onclick="clearData()" class="btn btn-danger">Clear Old Data</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading heatmap data...</p>
        </div>

        <div class="dashboard-grid">
            <!-- Weekly Statistics -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Weekly Statistics</div>
                        <div class="card-subtitle">Overview of quest and location activity</div>
                    </div>
                </div>
                <div id="weekly-stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-quests">-</div>
                            <div class="stat-label">Total Quests</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-visits">-</div>
                            <div class="stat-label">Location Visits</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stuck-events">-</div>
                            <div class="stat-label">Stuck Events</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="travel-paths">-</div>
                            <div class="stat-label">Travel Paths</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Quests -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Top Quests</div>
                        <div class="card-subtitle">Most frequently used quests</div>
                    </div>
                </div>
                <div id="quest-heatmap">
                    <div class="heatmap-placeholder">Loading quest data...</div>
                </div>
            </div>

            <!-- Most Visited Cities -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Most Visited Cities</div>
                        <div class="card-subtitle">Popular locations and areas</div>
                    </div>
                </div>
                <div id="city-heatmap">
                    <div class="heatmap-placeholder">Loading city data...</div>
                </div>
            </div>

            <!-- Danger Zones -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Danger Zones</div>
                        <div class="card-subtitle">Areas where the bot gets stuck frequently</div>
                    </div>
                </div>
                <div id="danger-zones">
                    <div class="heatmap-placeholder">Loading danger zone data...</div>
                </div>
            </div>

            <!-- Popular Paths -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Popular Travel Paths</div>
                        <div class="card-subtitle">Most common travel routes</div>
                    </div>
                </div>
                <div id="popular-paths">
                    <div class="heatmap-placeholder">Loading path data...</div>
                </div>
            </div>

            <!-- Coordinate Heatmap -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Coordinate Heatmap</div>
                        <div class="card-subtitle">Visual representation of activity density</div>
                    </div>
                    <div class="period-selector">
                        <select id="planet-selector" onchange="updateCoordinateHeatmap()">
                            <option value="Tatooine">Tatooine</option>
                            <option value="Naboo">Naboo</option>
                            <option value="Corellia">Corellia</option>
                            <option value="Dantooine">Dantooine</option>
                            <option value="Lok">Lok</option>
                        </select>
                    </div>
                </div>
                <div id="coordinate-heatmap" class="coordinate-heatmap">
                    <div class="heatmap-placeholder">Select a planet to view coordinate heatmap</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPeriod = 7;
        let currentPlanet = 'Tatooine';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateData();
        });

        // Update all data based on selected period
        function updateData() {
            currentPeriod = parseInt(document.getElementById('period').value);
            showLoading(true);
            
            Promise.all([
                loadWeeklyStats(),
                loadQuestData(),
                loadCityData(),
                loadDangerZones(),
                loadPopularPaths(),
                updateCoordinateHeatmap()
            ]).finally(() => {
                showLoading(false);
            });
        }

        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        // Load weekly statistics
        async function loadWeeklyStats() {
            try {
                const response = await fetch(`/api/admin/quest-heatmap/weekly-stats`);
                const data = await response.json();
                
                document.getElementById('total-quests').textContent = data.quest_stats?.total_quests || 0;
                document.getElementById('total-visits').textContent = data.city_stats?.total_visits || 0;
                document.getElementById('stuck-events').textContent = data.danger_stats?.total_stuck_events || 0;
                document.getElementById('travel-paths').textContent = data.path_stats?.total_paths || 0;
            } catch (error) {
                console.error('Error loading weekly stats:', error);
            }
        }

        // Load quest heatmap data
        async function loadQuestData() {
            try {
                const response = await fetch(`/api/admin/quest-heatmap/quest-data?days=${currentPeriod}`);
                const data = await response.json();
                
                const container = document.getElementById('quest-heatmap');
                if (data.top_quests && data.top_quests.length > 0) {
                    container.innerHTML = createQuestTable(data.top_quests);
                } else {
                    container.innerHTML = '<div class="heatmap-placeholder">No quest data available</div>';
                }
            } catch (error) {
                console.error('Error loading quest data:', error);
                document.getElementById('quest-heatmap').innerHTML = '<div class="heatmap-placeholder">Error loading quest data</div>';
            }
        }

        // Load city heatmap data
        async function loadCityData() {
            try {
                const response = await fetch(`/api/admin/quest-heatmap/city-data?days=${currentPeriod}`);
                const data = await response.json();
                
                const container = document.getElementById('city-heatmap');
                if (data.top_cities && data.top_cities.length > 0) {
                    container.innerHTML = createCityTable(data.top_cities);
                } else {
                    container.innerHTML = '<div class="heatmap-placeholder">No city data available</div>';
                }
            } catch (error) {
                console.error('Error loading city data:', error);
                document.getElementById('city-heatmap').innerHTML = '<div class="heatmap-placeholder">Error loading city data</div>';
            }
        }

        // Load danger zones data
        async function loadDangerZones() {
            try {
                const response = await fetch(`/api/admin/quest-heatmap/danger-zones?days=${currentPeriod}`);
                const data = await response.json();
                
                const container = document.getElementById('danger-zones');
                if (data.danger_zones && data.danger_zones.length > 0) {
                    container.innerHTML = createDangerZonesTable(data.danger_zones);
                } else {
                    container.innerHTML = '<div class="heatmap-placeholder">No danger zone data available</div>';
                }
            } catch (error) {
                console.error('Error loading danger zones:', error);
                document.getElementById('danger-zones').innerHTML = '<div class="heatmap-placeholder">Error loading danger zone data</div>';
            }
        }

        // Load popular paths data
        async function loadPopularPaths() {
            try {
                const response = await fetch(`/api/admin/quest-heatmap/popular-paths?days=${currentPeriod}`);
                const data = await response.json();
                
                const container = document.getElementById('popular-paths');
                if (data.popular_paths && data.popular_paths.length > 0) {
                    container.innerHTML = createPopularPathsTable(data.popular_paths);
                } else {
                    container.innerHTML = '<div class="heatmap-placeholder">No path data available</div>';
                }
            } catch (error) {
                console.error('Error loading popular paths:', error);
                document.getElementById('popular-paths').innerHTML = '<div class="heatmap-placeholder">Error loading path data</div>';
            }
        }

        // Update coordinate heatmap
        async function updateCoordinateHeatmap() {
            currentPlanet = document.getElementById('planet-selector').value;
            
            try {
                const response = await fetch(`/api/admin/quest-heatmap/coordinate-heatmap?planet=${currentPlanet}&days=${currentPeriod}`);
                const data = await response.json();
                
                const container = document.getElementById('coordinate-heatmap');
                if (data && data.length > 0) {
                    container.innerHTML = createCoordinateHeatmap(data);
                } else {
                    container.innerHTML = '<div class="heatmap-placeholder">No coordinate data available for ' + currentPlanet + '</div>';
                }
            } catch (error) {
                console.error('Error loading coordinate heatmap:', error);
                document.getElementById('coordinate-heatmap').innerHTML = '<div class="heatmap-placeholder">Error loading coordinate data</div>';
            }
        }

        // Create quest table
        function createQuestTable(quests) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Quest ID</th>
                            <th>Planet</th>
                            <th>Count</th>
                            <th>Top Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quests.map(quest => `
                            <tr>
                                <td><strong>${quest.quest_id}</strong></td>
                                <td>${quest.planet}</td>
                                <td><span class="popular-path">${quest.count}</span></td>
                                <td>${quest.locations[0]?.city || 'Unknown'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Create city table
        function createCityTable(cities) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>City</th>
                            <th>Planet</th>
                            <th>Visits</th>
                            <th>Visit Types</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cities.map(city => `
                            <tr>
                                <td><strong>${city.city}</strong></td>
                                <td>${city.planet}</td>
                                <td><span class="popular-path">${city.count}</span></td>
                                <td>${getVisitTypes(city.coordinates)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Create danger zones table
        function createDangerZonesTable(zones) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>City</th>
                            <th>Planet</th>
                            <th>Stuck Count</th>
                            <th>Avg Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${zones.map(zone => {
                            const avgDuration = zone.details.length > 0 
                                ? Math.round(zone.details.reduce((sum, detail) => sum + detail.duration_minutes, 0) / zone.details.length)
                                : 0;
                            return `
                                <tr>
                                    <td><strong>${zone.city}</strong></td>
                                    <td>${zone.planet}</td>
                                    <td><span class="danger-zone">${zone.stuck_count}</span></td>
                                    <td>${avgDuration} min</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Create popular paths table
        function createPopularPathsTable(paths) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>From</th>
                            <th>To</th>
                            <th>Count</th>
                            <th>Avg Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paths.map(path => {
                            const avgDuration = path.details.length > 0 
                                ? Math.round(path.details.reduce((sum, detail) => sum + detail.duration_minutes, 0) / path.details.length)
                                : 0;
                            return `
                                <tr>
                                    <td><strong>${path.from_city}, ${path.from_planet}</strong></td>
                                    <td><strong>${path.to_city}, ${path.to_planet}</strong></td>
                                    <td><span class="popular-path">${path.count}</span></td>
                                    <td>${avgDuration} min</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Create coordinate heatmap
        function createCoordinateHeatmap(data) {
            const container = document.createElement('div');
            container.style.position = 'relative';
            container.style.width = '100%';
            container.style.height = '300px';
            container.style.background = '#f8f9fa';
            container.style.borderRadius = '10px';
            container.style.overflow = 'hidden';

            // Find coordinate bounds
            const xCoords = data.map(point => point.x);
            const yCoords = data.map(point => point.y);
            const minX = Math.min(...xCoords);
            const maxX = Math.max(...xCoords);
            const minY = Math.min(...yCoords);
            const maxY = Math.max(...yCoords);

            // Scale coordinates to fit container
            const scaleX = 280 / (maxX - minX);
            const scaleY = 280 / (maxY - minY);
            const scale = Math.min(scaleX, scaleY);

            data.forEach(point => {
                const x = ((point.x - minX) * scale) + 10;
                const y = ((point.y - minY) * scale) + 10;
                const size = Math.max(5, Math.min(20, point.count * 2));
                const opacity = Math.max(0.3, Math.min(0.9, point.intensity));

                const dot = document.createElement('div');
                dot.className = 'heatmap-point';
                dot.style.left = x + 'px';
                dot.style.top = y + 'px';
                dot.style.width = size + 'px';
                dot.style.height = size + 'px';
                dot.style.background = `rgba(102, 126, 234, ${opacity})`;
                dot.title = `Count: ${point.count}, Coordinates: (${point.x}, ${point.y})`;

                container.appendChild(dot);
            });

            return container.outerHTML;
        }

        // Helper function to get visit types
        function getVisitTypes(coordinates) {
            const types = new Set();
            coordinates.forEach(coord => {
                if (coord.visit_type) {
                    types.add(coord.visit_type);
                }
            });
            return Array.from(types).join(', ') || 'Unknown';
        }

        // Clear old data
        function clearData() {
            if (confirm('Are you sure you want to clear old heatmap data? This action cannot be undone.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/quest-heatmap/clear-data';
                
                const daysInput = document.createElement('input');
                daysInput.type = 'hidden';
                daysInput.name = 'days';
                daysInput.value = '30';
                
                form.appendChild(daysInput);
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html> 