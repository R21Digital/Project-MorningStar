<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Tracker - Project MorningStar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .quest-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #007bff;
        }
        .quest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .quest-card.completed {
            border-left-color: #28a745;
        }
        .quest-card.in-progress {
            border-left-color: #ffc107;
        }
        .quest-card.failed {
            border-left-color: #dc3545;
        }
        .quest-card.not-started {
            border-left-color: #6c757d;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 0.25em 0.5em;
        }
        .difficulty-badge {
            font-size: 0.7em;
        }
        .progress-bar {
            height: 8px;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .widget-preview {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }
        .quest-category-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }
        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .popular-quests {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Header -->
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="/">
                            <i class="fas fa-star"></i> Project MorningStar
                        </a>
                        <div class="navbar-nav ms-auto">
                            <a class="nav-link" href="/">Dashboard</a>
                            <a class="nav-link active" href="/tools/quest-tracker">Quest Tracker</a>
                            <a class="nav-link" href="/tools">Tools</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <div class="container mt-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1><i class="fas fa-map-marked-alt"></i> Quest Tracker</h1>
                    <p class="text-muted">Track progress on major quests across the galaxy</p>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <h4><i class="fas fa-tasks"></i> Total Quests</h4>
                        <h2 id="total-quests">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h4><i class="fas fa-check-circle"></i> Completed</h4>
                        <h2 id="completed-quests">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h4><i class="fas fa-clock"></i> In Progress</h4>
                        <h2 id="in-progress-quests">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h4><i class="fas fa-users"></i> Active Players</h4>
                        <h2 id="active-players">0</h2>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="filter-section">
                        <h5><i class="fas fa-filter"></i> Filters</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label for="category-filter" class="form-label">Category</label>
                                <select class="form-select" id="category-filter">
                                    <option value="">All Categories</option>
                                    <option value="legacy">Legacy Quest</option>
                                    <option value="theme_park">Theme Parks</option>
                                    <option value="space">Space Quests</option>
                                    <option value="kashyyyk">Kashyyyk</option>
                                    <option value="mustafar">Mustafar</option>
                                    <option value="heroic">Heroic</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="difficulty-filter" class="form-label">Difficulty</label>
                                <select class="form-select" id="difficulty-filter">
                                    <option value="">All Difficulties</option>
                                    <option value="easy">Easy</option>
                                    <option value="normal">Normal</option>
                                    <option value="hard">Hard</option>
                                    <option value="heroic">Heroic</option>
                                    <option value="legendary">Legendary</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="planet-filter" class="form-label">Planet</label>
                                <select class="form-select" id="planet-filter">
                                    <option value="">All Planets</option>
                                    <option value="tatooine">Tatooine</option>
                                    <option value="naboo">Naboo</option>
                                    <option value="corellia">Corellia</option>
                                    <option value="rori">Rori</option>
                                    <option value="talus">Talus</option>
                                    <option value="dathomir">Dathomir</option>
                                    <option value="lok">Lok</option>
                                    <option value="endor">Endor</option>
                                    <option value="dantooine">Dantooine</option>
                                    <option value="yavin4">Yavin 4</option>
                                    <option value="kashyyyk">Kashyyyk</option>
                                    <option value="mustafar">Mustafar</option>
                                    <option value="space">Space</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="reward-filter" class="form-label">Reward Type</label>
                                <select class="form-select" id="reward-filter">
                                    <option value="">All Rewards</option>
                                    <option value="xp">Experience</option>
                                    <option value="credits">Credits</option>
                                    <option value="items">Items</option>
                                    <option value="titles">Titles</option>
                                    <option value="decorations">Decorations</option>
                                    <option value="vehicles">Vehicles</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="search-filter" class="form-label">Search</label>
                                <input type="text" class="form-control" id="search-filter" placeholder="Search quests...">
                            </div>
                            <div class="col-md-3">
                                <label for="status-filter" class="form-label">Status</label>
                                <select class="form-select" id="status-filter">
                                    <option value="">All Status</option>
                                    <option value="not_started">Not Started</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="applyFilters()">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Popular Quests -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="popular-quests">
                        <h5><i class="fas fa-fire"></i> What's Hot in the Galaxy</h5>
                        <div id="popular-quests-list" class="row">
                            <!-- Popular quests will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quest List -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-list"></i> Quest List</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="sortQuests('name')">
                                <i class="fas fa-sort-alpha-down"></i> Name
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="sortQuests('difficulty')">
                                <i class="fas fa-sort-numeric-down"></i> Difficulty
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="sortQuests('popularity')">
                                <i class="fas fa-fire"></i> Popularity
                            </button>
                        </div>
                    </div>
                    <div id="quest-list" class="row">
                        <!-- Quests will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-history"></i> Recent Activity</h6>
                        </div>
                        <div class="card-body recent-activity" id="recent-activity">
                            <!-- Recent activity will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-chart-bar"></i> Quest Statistics</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="quest-stats-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Widget Embed Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="widget-preview">
                        <h5><i class="fas fa-code"></i> Embed Widget</h5>
                        <p class="text-muted">Add this widget to your website to show quest progress</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="widget-code" readonly 
                                   value='<iframe src="/tools/quest-tracker/widget" width="100%" height="400" frameborder="0"></iframe>'>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyWidgetCode()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <div class="mt-3">
                            <h6>Preview:</h6>
                            <iframe src="/tools/quest-tracker/widget" width="100%" height="300" frameborder="0" style="border: 1px solid #ddd; border-radius: 4px;"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let allQuests = [];
        let filteredQuests = [];
        let currentFilters = {};

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestData();
            loadStatistics();
            loadRecentActivity();
            loadPopularQuests();
        });

        // Load quest data
        async function loadQuestData() {
            try {
                const response = await fetch('/api/quest-tracker/quests');
                const data = await response.json();
                
                if (data.success) {
                    allQuests = data.quests;
                    filteredQuests = [...allQuests];
                    displayQuests();
                    updateStatistics();
                }
            } catch (error) {
                console.error('Error loading quest data:', error);
            }
        }

        // Display quests
        function displayQuests() {
            const questList = document.getElementById('quest-list');
            questList.innerHTML = '';

            filteredQuests.forEach(quest => {
                const questCard = createQuestCard(quest);
                questList.appendChild(questCard);
            });
        }

        // Create quest card
        function createQuestCard(quest) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-3';

            const statusClass = getStatusClass(quest.status);
            const difficultyClass = getDifficultyClass(quest.difficulty);
            const categoryIcon = getCategoryIcon(quest.category);

            col.innerHTML = `
                <div class="card quest-card ${statusClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">
                                <span class="quest-category-icon">${categoryIcon}</span>
                                ${quest.name}
                            </h6>
                            <span class="badge ${statusClass} status-badge">${formatStatus(quest.status)}</span>
                        </div>
                        <p class="card-text text-muted small">${quest.description}</p>
                        <div class="row mb-2">
                            <div class="col-6">
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt"></i> ${quest.planet}
                                </small>
                            </div>
                            <div class="col-6">
                                <span class="badge ${difficultyClass} difficulty-badge">
                                    ${formatDifficulty(quest.difficulty)}
                                </span>
                            </div>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${quest.progress || 0}%" 
                                 aria-valuenow="${quest.progress || 0}" 
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${quest.estimated_duration || 0} min
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-users"></i> ${quest.current_players || 0} active
                            </small>
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        // Apply filters
        function applyFilters() {
            const category = document.getElementById('category-filter').value;
            const difficulty = document.getElementById('difficulty-filter').value;
            const planet = document.getElementById('planet-filter').value;
            const reward = document.getElementById('reward-filter').value;
            const search = document.getElementById('search-filter').value.toLowerCase();
            const status = document.getElementById('status-filter').value;

            currentFilters = { category, difficulty, planet, reward, search, status };

            filteredQuests = allQuests.filter(quest => {
                if (category && quest.category !== category) return false;
                if (difficulty && quest.difficulty !== difficulty) return false;
                if (planet && quest.planet !== planet) return false;
                if (reward && !quest.rewards.some(r => r.reward_type === reward)) return false;
                if (search && !quest.name.toLowerCase().includes(search) && 
                    !quest.description.toLowerCase().includes(search)) return false;
                if (status && quest.status !== status) return false;
                return true;
            });

            displayQuests();
        }

        // Sort quests
        function sortQuests(criteria) {
            filteredQuests.sort((a, b) => {
                switch (criteria) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'difficulty':
                        return getDifficultyValue(a.difficulty) - getDifficultyValue(b.difficulty);
                    case 'popularity':
                        return (b.popularity_score || 0) - (a.popularity_score || 0);
                    default:
                        return 0;
                }
            });
            displayQuests();
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/api/quest-tracker/statistics');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-quests').textContent = data.statistics.total_quests || 0;
                    document.getElementById('completed-quests').textContent = data.statistics.completed_quests || 0;
                    document.getElementById('in-progress-quests').textContent = data.statistics.in_progress_quests || 0;
                    document.getElementById('active-players').textContent = data.statistics.active_players || 0;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/quest-tracker/recent-activity');
                const data = await response.json();
                
                if (data.success) {
                    const activityContainer = document.getElementById('recent-activity');
                    activityContainer.innerHTML = '';

                    data.activities.forEach(activity => {
                        const activityItem = document.createElement('div');
                        activityItem.className = 'activity-item';
                        activityItem.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${activity.user_name}</strong> ${activity.action} 
                                    <strong>${activity.quest_name}</strong>
                                </div>
                                <small class="text-muted">${formatTime(activity.timestamp)}</small>
                            </div>
                        `;
                        activityContainer.appendChild(activityItem);
                    });
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        // Load popular quests
        async function loadPopularQuests() {
            try {
                const response = await fetch('/api/quest-tracker/popular');
                const data = await response.json();
                
                if (data.success) {
                    const popularContainer = document.getElementById('popular-quests-list');
                    popularContainer.innerHTML = '';

                    data.quests.forEach(quest => {
                        const col = document.createElement('div');
                        col.className = 'col-md-4 mb-2';
                        col.innerHTML = `
                            <div class="card border-0 bg-transparent">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <span class="quest-category-icon">${getCategoryIcon(quest.category)}</span>
                                        <div class="flex-grow-1">
                                            <small class="fw-bold">${quest.name}</small>
                                            <br>
                                            <small class="text-muted">${quest.planet} â€¢ ${quest.difficulty}</small>
                                        </div>
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-fire"></i> ${quest.popularity_score}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                        popularContainer.appendChild(col);
                    });
                }
            } catch (error) {
                console.error('Error loading popular quests:', error);
            }
        }

        // Copy widget code
        function copyWidgetCode() {
            const widgetCode = document.getElementById('widget-code');
            widgetCode.select();
            document.execCommand('copy');
            
            // Show feedback
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 2000);
        }

        // Helper functions
        function getStatusClass(status) {
            switch (status) {
                case 'completed': return 'completed';
                case 'in_progress': return 'in-progress';
                case 'failed': return 'failed';
                default: return 'not-started';
            }
        }

        function getDifficultyClass(difficulty) {
            switch (difficulty) {
                case 'easy': return 'bg-success';
                case 'normal': return 'bg-primary';
                case 'hard': return 'bg-warning';
                case 'heroic': return 'bg-danger';
                case 'legendary': return 'bg-dark';
                default: return 'bg-secondary';
            }
        }

        function getCategoryIcon(category) {
            switch (category) {
                case 'legacy': return '<i class="fas fa-crown"></i>';
                case 'theme_park': return '<i class="fas fa-theater-masks"></i>';
                case 'space': return '<i class="fas fa-rocket"></i>';
                case 'kashyyyk': return '<i class="fas fa-tree"></i>';
                case 'mustafar': return '<i class="fas fa-fire"></i>';
                case 'heroic': return '<i class="fas fa-shield-alt"></i>';
                case 'daily': return '<i class="fas fa-calendar-day"></i>';
                case 'weekly': return '<i class="fas fa-calendar-week"></i>';
                default: return '<i class="fas fa-quest"></i>';
            }
        }

        function formatStatus(status) {
            switch (status) {
                case 'completed': return 'Completed';
                case 'in_progress': return 'In Progress';
                case 'failed': return 'Failed';
                case 'not_started': return 'Not Started';
                default: return 'Unknown';
            }
        }

        function formatDifficulty(difficulty) {
            return difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        }

        function getDifficultyValue(difficulty) {
            const values = { easy: 1, normal: 2, hard: 3, heroic: 4, legendary: 5 };
            return values[difficulty] || 0;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function updateStatistics() {
            const stats = {
                total: filteredQuests.length,
                completed: filteredQuests.filter(q => q.status === 'completed').length,
                in_progress: filteredQuests.filter(q => q.status === 'in_progress').length,
                not_started: filteredQuests.filter(q => q.status === 'not_started').length
            };

            document.getElementById('total-quests').textContent = stats.total;
            document.getElementById('completed-quests').textContent = stats.completed;
            document.getElementById('in-progress-quests').textContent = stats.in_progress;
        }
    </script>
</body>
</html> 