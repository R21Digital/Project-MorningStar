{#
  Meta Tags Template for MorningStar SEO Enhancement System
  Dynamically generates meta tags with schema.org structured data
#}

{%- set seo = seo or {} -%}
{%- set site = seo.site or {} -%}
{%- set page = page or {} -%}
{%- set meta = seo.meta or {} -%}

{# Basic Meta Tags #}
<meta charset="{{ meta.charset or 'UTF-8' }}">
<meta name="viewport" content="{{ meta.viewport or 'width=device-width, initial-scale=1.0' }}">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

{# Title Tag with intelligent fallback #}
{%- if title -%}
  {%- if title == site.title -%}
    <title>{{ title }}</title>
  {%- else -%}
    <title>{{ title }} | {{ site.title }}</title>
  {%- endif -%}
{%- else -%}
  <title>{{ site.title }}</title>
{%- endif -%}

{# Meta Description with auto-generation from content #}
{%- set pageDescription = description or excerpt or content | stripHtml | truncate(160) -%}
{%- if pageDescription -%}
  <meta name="description" content="{{ pageDescription | escape }}">
{%- elif site.description -%}
  <meta name="description" content="{{ site.description | escape }}">
{%- endif -%}

{# Keywords Meta Tag #}
{%- set pageKeywords = keywords or tags -%}
{%- if pageKeywords -%}
  {%- if pageKeywords | length -%}
    <meta name="keywords" content="{{ pageKeywords | join(', ') | escape }}">
  {%- endif -%}
{%- elif seo.keywords.primary -%}
  <meta name="keywords" content="{{ seo.keywords.primary | join(', ') | escape }}">
{%- endif -%}

{# Author and Publisher #}
{%- if author -%}
  <meta name="author" content="{{ author | escape }}">
{%- elif seo.author.name -%}
  <meta name="author" content="{{ seo.author.name | escape }}">
{%- endif -%}

{%- if seo.author.url -%}
  <link rel="author" href="{{ seo.author.url }}">
{%- endif -%}

{# Robots Meta Tags #}
{%- set robotsContent = robots or meta.robots or 'index, follow' -%}
<meta name="robots" content="{{ robotsContent }}">
<meta name="googlebot" content="{{ meta.googlebot or 'index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1' }}">

{# Canonical URL #}
{%- set canonicalUrl = canonical or (site.url + (permalink or page.url)) -%}
<link rel="canonical" href="{{ canonicalUrl }}">

{# Generator #}
<meta name="generator" content="{{ meta.generator or 'Eleventy' }}">

{# Referrer Policy #}
<meta name="referrer" content="{{ meta.referrer or 'strict-origin-when-cross-origin' }}">

{# Theme Color #}
{%- if site.themeColor -%}
  <meta name="theme-color" content="{{ site.themeColor }}">
  <meta name="msapplication-TileColor" content="{{ site.themeColor }}">
{%- endif -%}

{# Favicon and App Icons #}
{%- if site.favicon -%}
  <link rel="icon" href="{{ site.favicon }}" type="image/x-icon">
  <link rel="shortcut icon" href="{{ site.favicon }}" type="image/x-icon">
{%- endif -%}

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

{# Open Graph Meta Tags #}
{%- set ogType = type or seo.openGraph.type or 'website' -%}
{%- set ogImage = image or featured_image or site.image -%}
{%- set ogUrl = canonicalUrl -%}
{%- set ogTitle = title or site.title -%}
{%- set ogDescription = pageDescription or site.description -%}

<meta property="og:type" content="{{ ogType }}">
<meta property="og:site_name" content="{{ seo.openGraph.siteName or site.title }}">
<meta property="og:locale" content="{{ seo.openGraph.locale or site.locale or 'en_US' }}">
<meta property="og:url" content="{{ ogUrl }}">
<meta property="og:title" content="{{ ogTitle | escape }}">
{%- if ogDescription -%}
  <meta property="og:description" content="{{ ogDescription | escape }}">
{%- endif -%}

{%- if ogImage -%}
  {%- set fullImageUrl = ogImage if ogImage.startswith('http') else (site.url + ogImage) -%}
  <meta property="og:image" content="{{ fullImageUrl }}">
  <meta property="og:image:alt" content="{{ image_alt or title or site.title | escape }}">
  <meta property="og:image:width" content="{{ image_width or '1200' }}">
  <meta property="og:image:height" content="{{ image_height or '630' }}">
{%- endif -%}

{# Article-specific Open Graph tags #}
{%- if ogType == 'article' -%}
  {%- if date -%}
    <meta property="article:published_time" content="{{ date | dateToIso }}">
  {%- endif -%}
  {%- if modified or updated -%}
    <meta property="article:modified_time" content="{{ (modified or updated) | dateToIso }}">
  {%- endif -%}
  {%- if author -%}
    <meta property="article:author" content="{{ author | escape }}">
  {%- endif -%}
  {%- if category -%}
    <meta property="article:section" content="{{ category | escape }}">
  {%- endif -%}
  {%- if tags -%}
    {%- for tag in tags -%}
      <meta property="article:tag" content="{{ tag | escape }}">
    {%- endfor -%}
  {%- endif -%}
{%- endif -%}

{# Twitter Card Meta Tags #}
{%- set twitterCard = twitter_card or seo.twitter.card or 'summary_large_image' -%}
<meta name="twitter:card" content="{{ twitterCard }}">
{%- if seo.twitter.site -%}
  <meta name="twitter:site" content="{{ seo.twitter.site }}">
{%- endif -%}
{%- if seo.twitter.creator -%}
  <meta name="twitter:creator" content="{{ seo.twitter.creator }}">
{%- endif -%}
<meta name="twitter:title" content="{{ ogTitle | escape }}">
{%- if ogDescription -%}
  <meta name="twitter:description" content="{{ ogDescription | escape }}">
{%- endif -%}
{%- if ogImage -%}
  <meta name="twitter:image" content="{{ fullImageUrl }}">
  <meta name="twitter:image:alt" content="{{ image_alt or title or site.title | escape }}">
{%- endif -%}

{# Schema.org Structured Data #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "{{ seo.structuredData.website['@type'] or 'WebSite' }}",
      "@id": "{{ site.url }}/#website",
      "url": "{{ site.url }}",
      "name": "{{ site.title | escape }}",
      "description": "{{ site.description | escape }}",
      "inLanguage": "{{ site.language or 'en-US' }}",
      {%- if seo.structuredData.website.potentialAction -%}
      "potentialAction": {{ seo.structuredData.website.potentialAction | dump | safe }},
      {%- endif -%}
      "publisher": {
        "@type": "{{ seo.organization.type or 'Organization' }}",
        "@id": "{{ site.url }}/#organization",
        "name": "{{ seo.organization.name or site.title | escape }}",
        "url": "{{ seo.organization.url or site.url }}",
        {%- if seo.organization.logo -%}
        "logo": {
          "@type": "ImageObject",
          "url": "{{ seo.organization.logo }}"
        },
        {%- endif -%}
        {%- if seo.organization.sameAs -%}
        "sameAs": {{ seo.organization.sameAs | dump | safe }}
        {%- endif -%}
      }
    },
    {
      "@type": "WebPage",
      "@id": "{{ canonicalUrl }}/#webpage",
      "url": "{{ canonicalUrl }}",
      "name": "{{ ogTitle | escape }}",
      {%- if ogDescription -%}
      "description": "{{ ogDescription | escape }}",
      {%- endif -%}
      "inLanguage": "{{ site.language or 'en-US' }}",
      "isPartOf": {
        "@id": "{{ site.url }}/#website"
      },
      {%- if date -%}
      "datePublished": "{{ date | dateToIso }}",
      {%- endif -%}
      {%- if modified or updated -%}
      "dateModified": "{{ (modified or updated) | dateToIso }}",
      {%- endif -%}
      {%- if ogImage -%}
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "url": "{{ fullImageUrl }}",
        {%- if image_alt -%}
        "description": "{{ image_alt | escape }}"
        {%- endif -%}
      },
      {%- endif -%}
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ site.url }}"
          }
          {%- if breadcrumbs -%}
            {%- for crumb in breadcrumbs -%}
            ,{
              "@type": "ListItem",
              "position": {{ loop.index + 1 }},
              "name": "{{ crumb.name | escape }}",
              "item": "{{ site.url }}{{ crumb.url }}"
            }
            {%- endfor -%}
          {%- endif -%}
        ]
      }
    }
    {%- if ogType == 'article' -%}
    ,{
      "@type": "Article",
      "@id": "{{ canonicalUrl }}/#article",
      "headline": "{{ ogTitle | escape }}",
      {%- if ogDescription -%}
      "description": "{{ ogDescription | escape }}",
      {%- endif -%}
      {%- if ogImage -%}
      "image": {
        "@type": "ImageObject",
        "url": "{{ fullImageUrl }}",
        {%- if image_alt -%}
        "description": "{{ image_alt | escape }}"
        {%- endif -%}
      },
      {%- endif -%}
      {%- if date -%}
      "datePublished": "{{ date | dateToIso }}",
      {%- endif -%}
      {%- if modified or updated -%}
      "dateModified": "{{ (modified or updated) | dateToIso }}",
      {%- endif -%}
      "author": {
        "@type": "Person",
        "name": "{{ author or seo.author.name | escape }}",
        {%- if seo.author.url -%}
        "url": "{{ seo.author.url }}"
        {%- endif -%}
      },
      "publisher": {
        "@id": "{{ site.url }}/#organization"
      },
      "mainEntityOfPage": {
        "@id": "{{ canonicalUrl }}/#webpage"
      },
      {%- if category -%}
      "articleSection": "{{ category | escape }}",
      {%- endif -%}
      {%- if tags -%}
      "keywords": {{ tags | dump | safe }},
      {%- endif -%}
      "isPartOf": {
        "@id": "{{ canonicalUrl }}/#webpage"
      }
    }
    {%- endif -%}
    {%- if seo.structuredData.software and (ogType == 'website' or not ogType) -%}
    ,{{ seo.structuredData.software | dump | safe }}
    {%- endif -%}
  ]
}
</script>

{# Additional structured data for software application #}
{%- if page_type == 'software' or layout == 'software' -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "{{ software_name or title or site.title | escape }}",
  "description": "{{ software_description or ogDescription | escape }}",
  "operatingSystem": "{{ operating_system or 'Windows' }}",
  "applicationCategory": "{{ application_category or 'GameApplication' }}",
  "url": "{{ canonicalUrl }}",
  {%- if download_url -%}
  "downloadUrl": "{{ download_url }}",
  {%- endif -%}
  {%- if software_version -%}
  "softwareVersion": "{{ software_version }}",
  {%- endif -%}
  {%- if features -%}
  "featureList": {{ features | dump | safe }},
  {%- endif -%}
  {%- if requirements -%}
  "requirements": "{{ requirements | escape }}",
  {%- endif -%}
  "offers": {
    "@type": "Offer",
    "price": "{{ price or '0' }}",
    "priceCurrency": "{{ currency or 'USD' }}"
  },
  "author": {
    "@type": "Organization",
    "name": "{{ seo.organization.name or site.title | escape }}"
  }
}
</script>
{%- endif -%}

{# FAQ Structured Data #}
{%- if faq -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {%- for item in faq -%}
    {
      "@type": "Question",
      "name": "{{ item.question | escape }}",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ item.answer | escape }}"
      }
    }{% if not loop.last %},{% endif %}
    {%- endfor -%}
  ]
}
</script>
{%- endif -%}

{# Search Engine Verification Tags #}
{%- if seo.verification -%}
  {%- if seo.verification.google -%}
    <meta name="google-site-verification" content="{{ seo.verification.google }}">
  {%- endif -%}
  {%- if seo.verification.bing -%}
    <meta name="msvalidate.01" content="{{ seo.verification.bing }}">
  {%- endif -%}
  {%- if seo.verification.yandex -%}
    <meta name="yandex-verification" content="{{ seo.verification.yandex }}">
  {%- endif -%}
  {%- if seo.verification.baidu -%}
    <meta name="baidu-site-verification" content="{{ seo.verification.baidu }}">
  {%- endif -%}
{%- endif -%}

{# Analytics Tags #}
{%- if seo.analytics -%}
  {%- if seo.analytics.google -%}
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ seo.analytics.google }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ seo.analytics.google }}', {
        anonymize_ip: true,
        cookie_flags: 'SameSite=None;Secure'
      });
    </script>
  {%- endif -%}
  
  {%- if seo.analytics.gtm -%}
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','{{ seo.analytics.gtm }}');</script>
  {%- endif -%}
{%- endif -%}

{# Preconnect to external domains for performance #}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">

{# DNS Prefetch for external resources #}
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">
<link rel="dns-prefetch" href="//www.google-analytics.com">
<link rel="dns-prefetch" href="//www.googletagmanager.com">

{# RSS Feed #}
{%- if collections.posts or feed_url -%}
  <link rel="alternate" type="application/rss+xml" title="{{ site.title }} RSS Feed" href="{{ feed_url or '/feed.xml' }}">
{%- endif -%}

{# Alternate language versions #}
{%- if alternates -%}
  {%- for alternate in alternates -%}
    <link rel="alternate" hreflang="{{ alternate.lang }}" href="{{ alternate.url }}">
  {%- endfor -%}
{%- endif -%}

{# Prev/Next pagination links #}
{%- if pagination -%}
  {%- if pagination.href.previous -%}
    <link rel="prev" href="{{ pagination.href.previous }}">
  {%- endif -%}
  {%- if pagination.href.next -%}
    <link rel="next" href="{{ pagination.href.next }}">
  {%- endif -%}
{%- endif -%}